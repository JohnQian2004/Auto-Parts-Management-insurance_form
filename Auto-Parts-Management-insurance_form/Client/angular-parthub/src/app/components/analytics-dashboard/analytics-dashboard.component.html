<div class="analytics-dashboard">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="fas fa-chart-line me-2 text-primary"></i>
        Subscription Analytics & Reports
      </h2>
      <p class="text-muted mb-0">Comprehensive insights into your subscription business</p>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-info btn-sm" (click)="testAuth()">
        <i class="fas fa-key me-1"></i>
        Test Auth
      </button>
      <select [(ngModel)]="selectedPeriod" (ngModelChange)="onPeriodChange()" class="form-select" style="width: auto;">
        <option *ngFor="let period of periods" [value]="period.value">{{ period.label }}</option>
      </select>
      <button class="btn btn-outline-primary" (click)="refreshAll()" [disabled]="isLoading">
        <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoading"></i>
        Refresh
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading analytics dashboard...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!isLoading && dashboardData" class="row g-4">
    
    <!-- Key Metrics Cards -->
    <div class="col-12">
      <div class="row g-3">
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="bg-primary bg-opacity-10 rounded-circle p-3 me-3">
                  <i class="fas fa-users fa-2x text-primary"></i>
                </div>
                <div>
                  <h3 class="mb-0 fw-bold text-primary">{{ formatNumber(dashboardData.totalSubscriptions) }}</h3>
                  <p class="mb-0 text-muted small">Total Subscriptions</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="bg-success bg-opacity-10 rounded-circle p-3 me-3">
                  <i class="fas fa-dollar-sign fa-2x text-success"></i>
                </div>
                <div>
                  <h3 class="mb-0 fw-bold text-success">{{ formatCurrency(dashboardData.totalRevenue) }}</h3>
                  <p class="mb-0 text-muted small">Monthly Revenue</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="bg-info bg-opacity-10 rounded-circle p-3 me-3">
                  <i class="fas fa-layer-group fa-2x text-info"></i>
                </div>
                <div>
                  <h3 class="mb-0 fw-bold text-info">{{ dashboardData.activePlans }}</h3>
                  <p class="mb-0 text-muted small">Active Plans</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div class="d-flex align-items-center justify-content-center mb-3">
                <div class="bg-warning bg-opacity-10 rounded-circle p-3 me-3">
                  <i class="fas fa-chart-line fa-2x text-warning"></i>
                </div>
                <div>
                  <h3 class="mb-0 fw-bold text-warning">{{ formatPercentage(dashboardData.growthAnalytics?.growthRate || 0) }}</h3>
                  <p class="mb-0 text-muted small">Growth Rate</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Revenue Trends Chart -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-line me-2 text-primary"></i>
            Revenue Trends
          </h5>
          <button class="btn btn-outline-primary btn-sm" (click)="loadRevenueTrends()" [disabled]="isLoadingRevenue">
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoadingRevenue"></i>
            Load
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingRevenue" class="text-center py-4">
            <div class="spinner-border text-primary"></div>
            <p class="mt-2 text-muted">Loading revenue trends...</p>
          </div>
          <div *ngIf="!isLoadingRevenue && revenueTrends" class="chart-container">
            <div class="revenue-chart">
              <div class="chart-header mb-3">
                <h6 class="text-muted mb-0">Revenue Trends ({{ selectedPeriod }} months)</h6>
              </div>
              <div class="chart-data">
                <div *ngFor="let item of revenueTrends.monthlyRevenue; let i = index" class="chart-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">{{ item.month }}</span>
                    <span class="text-primary fw-bold">{{ formatCurrency(item.revenue) }}</span>
                  </div>
                  <div class="progress" style="height: 8px;">
                    <div class="progress-bar bg-primary" 
                         [style.width.%]="getRevenueProgress(item.revenue, revenueTrends.monthlyRevenue)">
                    </div>
                  </div>
                </div>
              </div>
              <div class="chart-summary mt-3 p-3 bg-light rounded">
                <div class="row g-2">
                  <div class="col-6">
                    <small class="text-muted">Total Revenue</small>
                    <div class="fw-bold text-success">{{ formatCurrency(revenueTrends.totalRevenue) }}</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Avg Monthly</small>
                    <div class="fw-bold text-primary">{{ formatCurrency(revenueTrends.averageMonthlyRevenue) }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!isLoadingRevenue && !revenueTrends" class="text-center py-4">
            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
            <p class="text-muted">Click "Load" to view revenue trends</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Subscription Trends Chart -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-users me-2 text-success"></i>
            Subscription Trends
          </h5>
          <button class="btn btn-outline-success btn-sm" (click)="loadSubscriptionTrends()" [disabled]="isLoadingSubscriptions">
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoadingSubscriptions"></i>
            Load
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingSubscriptions" class="text-center py-4">
            <div class="spinner-border text-success"></div>
            <p class="mt-2 text-muted">Loading subscription trends...</p>
          </div>
          <div *ngIf="!isLoadingSubscriptions && subscriptionTrends" class="chart-container">
            <div class="subscription-chart">
              <div class="chart-header mb-3">
                <h6 class="text-muted mb-0">Subscription Trends ({{ selectedPeriod }} months)</h6>
              </div>
              <div class="chart-data">
                <div *ngFor="let item of subscriptionTrends.monthlySubscriptions; let i = index" class="chart-item">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">{{ item.month }}</span>
                    <div class="d-flex gap-3">
                      <span class="text-success small">+{{ item.newSubscriptions }}</span>
                      <span class="text-danger small">-{{ item.cancelledSubscriptions }}</span>
                      <span class="text-primary fw-bold">{{ item.netGrowth > 0 ? '+' : '' }}{{ item.netGrowth }}</span>
                    </div>
                  </div>
                  <div class="progress" style="height: 6px;">
                    <div class="progress-bar bg-success" 
                         [style.width.%]="getSubscriptionProgress(item.newSubscriptions, subscriptionTrends.monthlySubscriptions, 'new')">
                    </div>
                    <div class="progress-bar bg-danger" 
                         [style.width.%]="getSubscriptionProgress(item.cancelledSubscriptions, subscriptionTrends.monthlySubscriptions, 'cancelled')">
                    </div>
                  </div>
                </div>
              </div>
              <div class="chart-summary mt-3 p-3 bg-light rounded">
                <div class="row g-2">
                  <div class="col-6">
                    <small class="text-muted">Total Growth</small>
                    <div class="fw-bold text-success">{{ formatNumber(subscriptionTrends.totalGrowth) }}</div>
                  </div>
                  <div class="col-6">
                    <small class="text-muted">Avg Monthly</small>
                    <div class="fw-bold text-primary">{{ formatNumber(subscriptionTrends.averageMonthlyGrowth) }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!isLoadingSubscriptions && !subscriptionTrends" class="text-center py-4">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <p class="text-muted">Click "Load" to view subscription trends</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Plan Performance Chart -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-pie me-2 text-info"></i>
            Plan Performance
          </h5>
          <button class="btn btn-outline-info btn-sm" (click)="loadPlanPerformance()" [disabled]="isLoadingPlans">
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoadingPlans"></i>
            Load
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingPlans" class="text-center py-4">
            <div class="spinner-border text-info"></div>
            <p class="mt-2 text-muted">Loading plan performance...</p>
          </div>
          <div *ngIf="!isLoadingPlans && planPerformance" class="chart-container">
            <div class="plan-performance-chart">
              <div class="chart-header mb-3">
                <h6 class="text-muted mb-0">Plan Performance</h6>
              </div>
              <div class="chart-data">
                <div *ngFor="let plan of planPerformance.planPerformance; let i = index" class="plan-item mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="fw-medium">{{ plan.planName }}</span>
                    <span class="badge bg-primary">{{ plan.subscriberCount }} subscribers</span>
                  </div>
                  <div class="progress" style="height: 10px;">
                    <div class="progress-bar" 
                         [class]="getPlanColor(i)"
                         [style.width.%]="getPlanProgress(plan.subscriberCount, planPerformance.planPerformance)">
                    </div>
                  </div>
                  <div class="row g-2 mt-2">
                    <div class="col-6">
                      <small class="text-muted">Revenue</small>
                      <div class="fw-bold text-success">{{ formatCurrency(plan.revenue) }}</div>
                    </div>
                    <div class="col-6">
                      <small class="text-muted">Conversion</small>
                      <div class="fw-bold text-info">{{ formatPercentage(plan.conversionRate) }}</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="chart-summary mt-3 p-3 bg-light rounded">
                <div class="text-center">
                  <small class="text-muted">Top Performing Plan</small>
                  <div class="fw-bold text-primary">{{ planPerformance.topPerformingPlan }}</div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!isLoadingPlans && !planPerformance" class="text-center py-4">
            <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
            <p class="text-muted">Click "Load" to view plan performance</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Vendor Insights -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-building me-2 text-warning"></i>
            Vendor Insights
          </h5>
          <button class="btn btn-outline-warning btn-sm" (click)="loadVendorInsights()" [disabled]="isLoadingVendors">
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoadingVendors"></i>
            Load
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingVendors" class="text-center py-4">
            <div class="spinner-border text-warning"></div>
            <p class="mt-2 text-muted">Loading vendor insights...</p>
          </div>
          <div *ngIf="!isLoadingVendors && vendorInsights" class="vendor-insights">
            <div class="row g-3">
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-primary">{{ formatNumber(vendorInsights.totalVendors) }}</h4>
                  <p class="mb-0 text-muted small">Total Vendors</p>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-success">{{ formatNumber(vendorInsights.newVendorsThisMonth) }}</h4>
                  <p class="mb-0 text-muted small">New This Month</p>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-info">{{ formatCurrency(vendorInsights.averageSubscriptionValue) }}</h4>
                  <p class="mb-0 text-muted small">Avg. Subscription Value</p>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-warning">{{ formatPercentage(vendorInsights.vendorRetentionRate) }}</h4>
                  <p class="mb-0 text-muted small">Retention Rate</p>
                </div>
              </div>
            </div>
            
            <!-- Vendor Distribution -->
            <div class="mt-4">
              <h6 class="text-muted mb-3">Vendor Distribution</h6>
              <div *ngFor="let segment of vendorInsights.vendorDistribution | keyvalue" class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-medium">{{ getSegmentKey(segment) }}</span>
                <div class="d-flex align-items-center">
                  <div class="progress me-2" style="width: 100px; height: 8px;">
                    <div class="progress-bar" 
                         [style.width.%]="getVendorDistributionProgress(segment, vendorInsights.totalVendors)"
                         [class]="getSegmentColor(getSegmentKey(segment))">
                    </div>
                  </div>
                  <span class="small text-muted">{{ getSegmentValue(segment) }}</span>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!isLoadingVendors && !vendorInsights" class="text-center py-4">
            <i class="fas fa-building fa-3x text-muted mb-3"></i>
            <p class="text-muted">Click "Load" to view vendor insights</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Churn Analysis -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-chart-bar me-2 text-danger"></i>
            Churn Analysis
          </h5>
          <button class="btn btn-outline-danger btn-sm" (click)="loadChurnAnalysis()" [disabled]="isLoadingChurn">
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoadingChurn"></i>
            Load
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingChurn" class="text-center py-4">
            <div class="spinner-border text-danger"></div>
            <p class="mt-2 text-muted">Loading churn analysis...</p>
          </div>
          <div *ngIf="!isLoadingChurn && churnAnalysis" class="churn-analysis">
            <div class="row g-3 mb-4">
              <div class="col-4">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-danger">{{ formatPercentage(churnAnalysis.overallChurnRate) }}</h4>
                  <p class="mb-0 text-muted small">Overall Churn Rate</p>
                </div>
              </div>
              <div class="col-4">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-warning">{{ formatNumber(churnAnalysis.churnedSubscriptions) }}</h4>
                  <p class="mb-0 text-muted small">Churned Subscriptions</p>
                </div>
              </div>
              <div class="col-4">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-success">{{ formatPercentage(churnAnalysis.retentionRate) }}</h4>
                  <p class="mb-0 text-muted small">Retention Rate</p>
                </div>
              </div>
            </div>
            
            <!-- Churn by Plan -->
            <div *ngIf="churnAnalysis.churnByPlan" class="churn-by-plan">
              <h6 class="text-muted mb-3">Churn Rate by Plan Type</h6>
              <div *ngFor="let churn of churnAnalysis.churnByPlan | keyvalue; let i = index" class="churn-item mb-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <span class="fw-medium">{{ getChurnKey(churn) }}</span>
                  <span class="badge" [class]="getChurnBadgeColor(getChurnValue(churn))">{{ formatPercentage(getChurnValue(churn)) }}</span>
                </div>
                <div class="progress" style="height: 8px;">
                  <div class="progress-bar" 
                       [class]="getChurnBarColor(getChurnValue(churn))"
                       [style.width.%]="getChurnValue(churn) * 100">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!isLoadingChurn && !churnAnalysis" class="text-center py-4">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <p class="text-muted">Click "Load" to view churn analysis</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Conversion Funnel -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="fas fa-funnel-dollar me-2 text-purple"></i>
            Conversion Funnel
          </h5>
          <button class="btn btn-outline-purple btn-sm" (click)="loadConversionFunnel()" [disabled]="isLoadingConversion">
            <i class="fas fa-sync-alt me-1" [class.fa-spin]="isLoadingConversion"></i>
            Load
          </button>
        </div>
        <div class="card-body">
          <div *ngIf="isLoadingConversion" class="text-center py-4">
            <div class="spinner-border text-purple"></div>
            <p class="mt-2 text-muted">Loading conversion funnel...</p>
          </div>
          <div *ngIf="!isLoadingConversion && conversionFunnel" class="conversion-funnel">
            <div class="row g-3 mb-4">
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-primary">{{ formatPercentage(conversionFunnel.trialToPaidConversion) }}</h4>
                  <p class="mb-0 text-muted small">Trial to Paid</p>
                </div>
              </div>
              <div class="col-6">
                <div class="text-center p-3 bg-light rounded">
                  <h4 class="mb-1 fw-bold text-success">{{ formatPercentage(conversionFunnel.overallConversion) }}</h4>
                  <p class="mb-0 text-muted small">Overall Conversion</p>
                </div>
              </div>
            </div>
            
            <!-- Funnel Steps -->
            <div class="funnel-steps">
              <div *ngFor="let step of conversionFunnel.funnelSteps | keyvalue; let i = index" 
                   class="funnel-step mb-2">
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-medium">{{ getFunnelStepKey(step) }}</span>
                  <span class="badge bg-primary">{{ formatNumber(getFunnelStepValue(step)) }}</span>
                </div>
                <div class="progress mt-1" style="height: 8px;">
                  <div class="progress-bar" 
                       [style.width.%]="getFunnelStepProgress(step, conversionFunnel.funnelSteps | keyvalue)"
                       [class]="getFunnelStepColor(i)">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="!isLoadingConversion && !conversionFunnel" class="text-center py-4">
            <i class="fas fa-funnel-dollar fa-3x text-muted mb-3"></i>
            <p class="text-muted">Click "Load" to view conversion funnel</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
