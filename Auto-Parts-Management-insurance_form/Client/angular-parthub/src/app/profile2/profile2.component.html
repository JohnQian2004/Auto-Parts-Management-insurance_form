<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <h1 class="mb-4">User Profile</h1>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Profile Content -->
  <div *ngIf="!loading" class="row">
    <!-- Sidebar -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-body text-center">
          <div class="mb-3">
            <div class="avatar-placeholder">
              <span class="avatar-text">{{ getInitials() }}</span>
            </div>
          </div>
          <h5 class="card-title">{{ getFullName() }}</h5>
          <p class="text-muted">{{ user?.email }}</p>
          <p class="text-muted small">{{ user?.username }}</p>
        </div>
      </div>

      <!-- Navigation Tabs -->
      <div class="list-group mt-3">
        <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'profile'"
          (click)="setActiveTab('profile')">
          <i class="bi bi-person me-2"></i>
          Personal Information
        </button>
        <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'security'"
          (click)="setActiveTab('security')">
          <i class="bi bi-shield-lock me-2"></i>
          Security
        </button>
        <button *ngIf="isVendor()" class="list-group-item list-group-item-action"
          [class.active]="activeTab === 'my-subscriptions'" (click)="setActiveTab('my-subscriptions')">
          <i class="bi bi-wallet2 me-2"></i>
          My Subscriptions
        </button>
        <button *ngIf="isVendor()" class="list-group-item list-group-item-action"
          [class.active]="activeTab === 'subscriptions'" (click)="setActiveTab('subscriptions')">
          <i class="bi bi-credit-card me-2"></i>
          Subscription History
        </button>
        <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'bookings'"
          (click)="setActiveTab('bookings')">
          <i class="bi bi-bag me-2"></i>
          Booking History
        </button>
        <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'incomplete'"
          (click)="setActiveTab('incomplete')">
          <i class="bi bi-clock-history me-2"></i>
          Incomplete Bookings
        </button>
        <button class="list-group-item list-group-item-action" [class.active]="activeTab === 'addresses'"
          (click)="setActiveTab('addresses')">
          <i class="bi bi-geo-alt me-2"></i>
          Shipping Addresses
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="col-md-9">
      <!-- Personal Information Tab -->
      <div *ngIf="activeTab === 'profile'" class="card">
        <div class="card-header">
          <h5 class="mb-0">Personal Information</h5>
        </div>
        <div class="card-body">
          <div *ngIf="profileLoading" class="text-center">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <form [formGroup]="profileForm" (ngSubmit)="updateProfile()" *ngIf="!profileLoading">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" formControlName="firstName"
                  [class.is-invalid]="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched">
                <div class="invalid-feedback"
                  *ngIf="profileForm.get('firstName')?.invalid && profileForm.get('firstName')?.touched">
                  First name is required
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" formControlName="lastName"
                  [class.is-invalid]="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched">
                <div class="invalid-feedback"
                  *ngIf="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched">
                  Last name is required
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" formControlName="email"
                [class.is-invalid]="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
              <div class="invalid-feedback"
                *ngIf="profileForm.get('email')?.invalid && profileForm.get('email')?.touched">
                Email is required
              </div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="phone" class="form-label">Phone</label>
                <input type="tel" class="form-control" id="phone" formControlName="phone">
              </div>
              <div class="col-md-6 mb-3">
                <label for="dateOfBirth" class="form-label">Date of Birth</label>
                <input type="date" class="form-control" id="dateOfBirth" formControlName="dateOfBirth">
              </div>
            </div>

            <div class="mb-3">
              <label for="gender" class="form-label">Gender</label>
              <select class="form-select" id="gender" formControlName="gender">
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary" [disabled]="profileForm.invalid || profileLoading">
              <span *ngIf="profileLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
              Update Profile
            </button>
          </form>
        </div>
      </div>

      <!-- Booking History Tab -->
      <div *ngIf="activeTab === 'bookings'" class="card">
        <div class="card-header">
          <h5 class="mb-0">Booking History</h5>
        </div>
        <div class="card-body">
          <div *ngIf="bookingsLoading" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <div *ngIf="!bookingsLoading && bookings.length === 0" class="text-center py-4">
            <i class="bi bi-bag-x fs-1 text-muted"></i>
            <p class="mt-3">No bookings found</p>
          </div>

          <div *ngIf="!bookingsLoading && bookings.length > 0">
            <div class="table-responsive">
              <table class="table">
                <thead>
                  <tr>
                    <th>Booking Reference</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Travel Date</th>
                    <th>Number of People</th>
                    <th>Total</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let booking of bookings">
                    <td>{{ booking.bookingReference }}</td>
                    <td>{{ booking.bookingDate | date:'short' }}</td>
                    <td>
                      <span [class]="getBookingStatusClass(booking.bookingStatus)">
                        {{ getBookingStatusText(booking.bookingStatus) }}
                      </span>
                    </td>
                    <td>{{ booking.travelDate | date:'short' }}</td>
                    <td>{{ booking.numberOfPeople }}</td>
                    <td>${{ booking.totalAmount.toFixed(2) }}</td>
                    <td>
                      <button class="btn btn-sm btn-outline-primary" (click)="viewBookingDetails(booking)">
                        View Details
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Incomplete Bookings Tab -->
      <div *ngIf="activeTab === 'incomplete'" class="card">
        <div class="card-header">
          <h5 class="mb-0">Incomplete Bookings</h5>
        </div>
        <div class="card-body">
          <p>Continue with your incomplete bookings or remove them if you no longer wish to proceed.</p>
          <a routerLink="/incomplete-bookings" class="btn btn-primary">
            <i class="bi bi-clock-history me-2"></i>
            Manage Incomplete Bookings
          </a>
        </div>
      </div>

      <!-- Shipping Addresses Tab -->
      <div *ngIf="activeTab === 'addresses'" class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Shipping Addresses</h5>
          <button class="btn btn-primary btn-sm" (click)="toggleAddressForm()">
            <i class="bi bi-plus"></i>
            Add Address
          </button>
        </div>
        <div class="card-body">
          <!-- Address Form -->
          <div *ngIf="showAddressForm" class="mb-4">
            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">{{ editingAddress ? 'Edit Address' : 'Add Address' }}</h6>
              </div>
              <div class="card-body">
                <form [formGroup]="addressForm"
                  (ngSubmit)="editingAddress ? updateShippingAddress() : addShippingAddress()">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="addressFirstName" class="form-label">First Name</label>
                      <input type="text" class="form-control" id="addressFirstName" formControlName="firstName"
                        [class.is-invalid]="addressForm.get('firstName')?.invalid && addressForm.get('firstName')?.touched">
                      <div class="invalid-feedback"
                        *ngIf="addressForm.get('firstName')?.invalid && addressForm.get('firstName')?.touched">
                        First name is required
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="addressLastName" class="form-label">Last Name</label>
                      <input type="text" class="form-control" id="addressLastName" formControlName="lastName"
                        [class.is-invalid]="addressForm.get('lastName')?.invalid && addressForm.get('lastName')?.touched">
                      <div class="invalid-feedback"
                        *ngIf="addressForm.get('lastName')?.invalid && addressForm.get('lastName')?.touched">
                        Last name is required
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="addressLine1" class="form-label">Address Line 1</label>
                    <input type="text" class="form-control" id="addressLine1" formControlName="addressLine1"
                      [class.is-invalid]="addressForm.get('addressLine1')?.invalid && addressForm.get('addressLine1')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="addressForm.get('addressLine1')?.invalid && addressForm.get('addressLine1')?.touched">
                      Address line 1 is required
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="addressLine2" class="form-label">Address Line 2</label>
                    <input type="text" class="form-control" id="addressLine2" formControlName="addressLine2">
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="city" class="form-label">City</label>
                      <input type="text" class="form-control" id="city" formControlName="city"
                        [class.is-invalid]="addressForm.get('city')?.invalid && addressForm.get('city')?.touched">
                      <div class="invalid-feedback"
                        *ngIf="addressForm.get('city')?.invalid && addressForm.get('city')?.touched">
                        City is required
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="state" class="form-label">State</label>
                      <input type="text" class="form-control" id="state" formControlName="state"
                        [class.is-invalid]="addressForm.get('state')?.invalid && addressForm.get('state')?.touched">
                      <div class="invalid-feedback"
                        *ngIf="addressForm.get('state')?.invalid && addressForm.get('state')?.touched">
                        State is required
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="postalCode" class="form-label">Postal Code</label>
                      <input type="text" class="form-control" id="postalCode" formControlName="postalCode"
                        [class.is-invalid]="addressForm.get('postalCode')?.invalid && addressForm.get('postalCode')?.touched">
                      <div class="invalid-feedback"
                        *ngIf="addressForm.get('postalCode')?.invalid && addressForm.get('postalCode')?.touched">
                        Postal code is required
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="country" class="form-label">Country</label>
                      <select class="form-select" id="country" formControlName="country"
                        [class.is-invalid]="addressForm.get('country')?.invalid && addressForm.get('country')?.touched">
                        <option value="">Select Country</option>
                        <option *ngFor="let country of countries" [value]="country.code">
                          {{ country.name }} {{ country.nativeName !== country.name ? '(' + country.nativeName + ')' :
                          '' }}
                        </option>
                      </select>
                      <div class="invalid-feedback"
                        *ngIf="addressForm.get('country')?.invalid && addressForm.get('country')?.touched">
                        Country is required
                      </div>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="addressPhone" class="form-label">Phone</label>
                    <input type="tel" class="form-control" id="addressPhone" formControlName="phone"
                      [class.is-invalid]="addressForm.get('phone')?.invalid && addressForm.get('phone')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="addressForm.get('phone')?.invalid && addressForm.get('phone')?.touched">
                      Phone is required
                    </div>
                  </div>

                  <div class="mb-3">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="isDefault" formControlName="isDefault">
                      <label class="form-check-label" for="isDefault">
                        Set as default address
                      </label>
                    </div>
                  </div>

                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary" [disabled]="addressForm.invalid">
                      {{ editingAddress ? 'Update Address' : 'Add Address' }}
                    </button>
                    <button type="button" class="btn btn-secondary" (click)="toggleAddressForm()">
                      Cancel
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Addresses List -->
          <div *ngIf="addressesLoading" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>

          <div *ngIf="!addressesLoading && shippingAddresses.length === 0" class="text-center py-4">
            <i class="bi bi-geo-alt-x fs-1 text-muted"></i>
            <p class="mt-3">No addresses found</p>
          </div>

          <div *ngIf="!addressesLoading && shippingAddresses.length > 0" class="row">
            <div class="col-md-6 mb-3" *ngFor="let address of shippingAddresses">
              <div class="card h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="card-title mb-0">{{ address.firstName }} {{ address.lastName }}</h6>
                    <div>
                      <span *ngIf="address.isDefault" class="badge bg-primary me-1">Default</span>
                      <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" (click)="editAddress(address)">
                          <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" (click)="deleteShippingAddress(address.id)">
                          <i class="bi bi-trash"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <p class="card-text small mb-1">{{ address.addressLine1 }}</p>
                  <p class="card-text small mb-1" *ngIf="address.addressLine2">{{ address.addressLine2 }}</p>
                  <p class="card-text small mb-1">{{ address.city }}, {{ address.state }} {{ address.postalCode }}</p>
                  <p class="card-text small mb-1">
                    {{ getCountryDisplayName(address.country) }}
                  </p>
                  <p class="card-text small text-muted">{{ address.phone }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Security Tab -->
      <div *ngIf="activeTab === 'security'" class="card">
        <div class="card-header">
          <h5 class="mb-0">Security</h5>
        </div>
        <div class="card-body">
          <!-- Username Change Section -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h6 class="mb-1">Change Username</h6>
                <p class="text-muted small mb-0">Update your username to something new</p>
              </div>
              <button class="btn btn-outline-primary btn-sm" (click)="toggleUsernameForm()">
                {{ showUsernameForm ? 'Cancel' : 'Change Username' }}
              </button>
            </div>

            <div *ngIf="showUsernameForm" class="card">
              <div class="card-body">
                <form [formGroup]="usernameForm" (ngSubmit)="changeUsername()">
                  <div class="mb-3">
                    <label for="newUsername" class="form-label">New Username</label>
                    <input type="text" class="form-control" id="newUsername" formControlName="newUsername"
                      [class.is-invalid]="usernameForm.get('newUsername')?.invalid && usernameForm.get('newUsername')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="usernameForm.get('newUsername')?.invalid && usernameForm.get('newUsername')?.touched">
                      <span *ngIf="usernameForm.get('newUsername')?.errors?.['required']">Username is required</span>
                      <span *ngIf="usernameForm.get('newUsername')?.errors?.['minlength']">Username must be at least 3
                        characters</span>
                      <span *ngIf="usernameForm.get('newUsername')?.errors?.['pattern']">Username can only contain
                        letters, numbers, and underscores</span>
                    </div>
                    <div class="form-text">Choose a unique username (3-20 characters)</div>
                  </div>

                  <div class="mb-3">
                    <label for="usernameCurrentPassword" class="form-label">Current Password</label>
                    <input type="password" class="form-control" id="usernameCurrentPassword"
                      formControlName="currentPassword"
                      [class.is-invalid]="usernameForm.get('currentPassword')?.invalid && usernameForm.get('currentPassword')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="usernameForm.get('currentPassword')?.invalid && usernameForm.get('currentPassword')?.touched">
                      Current password is required
                    </div>
                  </div>

                  <button type="submit" class="btn btn-primary" [disabled]="usernameForm.invalid || usernameLoading">
                    <span *ngIf="usernameLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Update Username
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Password Change Section -->
          <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h6 class="mb-1">Change Password</h6>
                <p class="text-muted small mb-0">Update your password to keep your account secure</p>
              </div>
              <button class="btn btn-outline-primary btn-sm" (click)="togglePasswordForm()">
                {{ showPasswordForm ? 'Cancel' : 'Change Password' }}
              </button>
            </div>

            <div *ngIf="showPasswordForm" class="card">
              <div class="card-body">
                <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
                  <div class="mb-3">
                    <label for="currentPassword" class="form-label">Current Password</label>
                    <input type="password" class="form-control" id="currentPassword" formControlName="currentPassword"
                      [class.is-invalid]="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched">
                      Current password is required
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="newPassword" class="form-label">New Password</label>
                    <input type="password" class="form-control" id="newPassword" formControlName="newPassword"
                      [class.is-invalid]="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched">
                      <span *ngIf="passwordForm.get('newPassword')?.errors?.['required']">New password is
                        required</span>
                      <span *ngIf="passwordForm.get('newPassword')?.errors?.['minlength']">Password must be at least 8
                        characters</span>
                    </div>
                  </div>

                  <div class="mb-3">
                    <label for="confirmPassword" class="form-label">Confirm Password</label>
                    <input type="password" class="form-control" id="confirmPassword" formControlName="confirmPassword"
                      [class.is-invalid]="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched">
                    <div class="invalid-feedback"
                      *ngIf="passwordForm.get('confirmPassword')?.invalid && passwordForm.get('confirmPassword')?.touched">
                      <span *ngIf="passwordForm.get('confirmPassword')?.errors?.['required']">Confirm password is
                        required</span>
                      <span *ngIf="passwordForm.errors?.['passwordMismatch']">Passwords do not match</span>
                    </div>
                  </div>

                  <button type="submit" class="btn btn-primary" [disabled]="passwordForm.invalid || passwordLoading">
                    <span *ngIf="passwordLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                    Update Password
                  </button>
                </form>
              </div>
            </div>
          </div>

          <!-- Logout Section -->
          <div class="border-top pt-3">
            <h6 class="mb-2">Logout</h6>
            <p class="text-muted small mb-3">Sign out of your account</p>
            <button class="btn btn-outline-danger" (click)="logout()">
              <i class="bi bi-box-arrow-right me-2"></i>
              Logout
            </button>
          </div>
        </div>
      </div>

      <!-- Subscription History Tab (Vendor Only) -->
      <div *ngIf="activeTab === 'subscriptions'" class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-credit-card me-2"></i>
            Subscription History
          </h5>
        </div>
        <div class="card-body">
          <!-- Loading State -->
          <div *ngIf="subscriptionsLoading" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading subscriptions...</span>
            </div>
            <p class="mt-2 text-muted">Loading your subscription history...</p>
          </div>

          <!-- No Subscriptions -->
          <div *ngIf="!subscriptionsLoading && vendorSubscriptions.length === 0" class="text-center py-4">
            <i class="bi bi-credit-card text-muted" style="font-size: 3rem;"></i>
            <h6 class="mt-3 text-muted">No Subscriptions Found</h6>
            <p class="text-muted">You haven't subscribed to any plans yet.</p>
          </div>

          <!-- Subscriptions List -->
          <div *ngIf="!subscriptionsLoading && vendorSubscriptions.length > 0">
            <div class="row">
              <div class="col-12">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>Plan</th>
                        <th>Status</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Duration</th>
                        <th>Amount</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let subscription of vendorSubscriptions; trackBy: trackBySubscription">
                        <tr>
                          <td>
                            <div class="d-flex align-items-center">
                              <div>
                                <h6 class="mb-1">{{ subscription.planName || 'Unknown Plan' }}</h6>
                                <small class="text-muted">{{ subscription.planDescription || 'No description' }}</small>
                              </div>
                            </div>
                          </td>
                          <td>
                            <span class="badge" [class]="getSubscriptionStatusBadge(subscription.status)">
                              {{ subscription.status }}
                            </span>
                          </td>
                          <td>
                            <span *ngIf="subscription.startDate">{{ subscription.startDate | date:'MMM dd, yyyy'
                              }}</span>
                            <span *ngIf="!subscription.startDate" class="text-muted">N/A</span>
                          </td>
                          <td>
                            <span *ngIf="subscription.endDate">{{ subscription.endDate | date:'MMM dd, yyyy' }}</span>
                            <span *ngIf="!subscription.endDate" class="text-muted">N/A</span>
                          </td>
                          <td>
                            <span class="text-muted">{{ getSubscriptionDuration(subscription) }}</span>
                          </td>
                          <td>
                            <span *ngIf="subscription.planPrice && subscription.planPrice > 0"
                              class="fw-bold text-success">
                              ${{ subscription.planPrice | number:'1.2-2' }}
                            </span>
                            <span *ngIf="!subscription.planPrice || subscription.planPrice === 0"
                              class="text-muted">Free</span>
                          </td>
                          <td>
                            <button class="btn btn-outline-primary btn-sm" (click)="loadPaymentDetails(subscription)"
                              [disabled]="loadingPaymentDetails[subscription.id!]">
                              <span *ngIf="loadingPaymentDetails[subscription.id!]"
                                class="spinner-border spinner-border-sm me-1"></span>
                              <i class="bi bi-credit-card me-1"></i>
                              Payment Details
                            </button>
                          </td>
                        </tr>

                        <!-- Payment Details Row -->
                        <tr
                          *ngIf="showPaymentDetails[subscription.id!] && subscriptionPaymentDetails[subscription.id!]">
                          <td colspan="7">
                            <div class="card border-0 bg-light">
                              <div class="card-header bg-transparent">
                                <h6 class="mb-0">
                                  <i class="bi bi-receipt me-2 text-primary"></i>
                                  Payment Details (Database)
                                </h6>
                              </div>
                              <div class="card-body">
                                <div class="row">
                                  <div class="col-md-4" *ngIf="subscriptionPaymentDetails[subscription.id!].status">
                                    <div class="mb-2">
                                      <label class="fw-medium text-muted">Payment Status:</label>
                                      <span class="badge ms-2"
                                        [class]="getPaymentStatusBadge(subscriptionPaymentDetails[subscription.id!].status)">
                                        {{ subscriptionPaymentDetails[subscription.id!].status }}
                                      </span>
                                    </div>
                                  </div>
                                  <div class="col-md-4" *ngIf="subscriptionPaymentDetails[subscription.id!].amount">
                                    <div class="mb-2">
                                      <label class="fw-medium text-muted">Amount:</label>
                                      <div class="fw-bold text-success">${{
                                        subscriptionPaymentDetails[subscription.id!].amount | number:'1.2-2' }}</div>
                                    </div>
                                  </div>
                                  <div class="col-md-4" *ngIf="subscriptionPaymentDetails[subscription.id!].currency">
                                    <div class="mb-2">
                                      <label class="fw-medium text-muted">Currency:</label>
                                      <div class="text-uppercase">{{
                                        subscriptionPaymentDetails[subscription.id!].currency }}</div>
                                    </div>
                                  </div>
                                  <div class="col-md-4"
                                    *ngIf="subscriptionPaymentDetails[subscription.id!].paymentMethodType">
                                    <div class="mb-2">
                                      <label class="fw-medium text-muted">Payment Method:</label>
                                      <div>{{ subscriptionPaymentDetails[subscription.id!].paymentMethodType }}</div>
                                    </div>
                                  </div>
                                  <div class="col-md-4"
                                    *ngIf="subscriptionPaymentDetails[subscription.id!].paymentMethodLast4">
                                    <div class="mb-2">
                                      <label class="fw-medium text-muted">Card Last 4:</label>
                                      <div class="font-monospace">**** {{
                                        subscriptionPaymentDetails[subscription.id!].paymentMethodLast4 }}</div>
                                    </div>
                                  </div>
                                  <div class="col-md-4"
                                    *ngIf="subscriptionPaymentDetails[subscription.id!].processedAt">
                                    <div class="mb-2">
                                      <label class="fw-medium text-muted">Processed At:</label>
                                      <div>{{ subscriptionPaymentDetails[subscription.id!].processedAt | date:'MMM dd,
                                        yyyy HH:mm' }}</div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Stripe IDs Section -->
                                <div class="row mt-3"
                                  *ngIf="subscriptionPaymentDetails[subscription.id!].stripeCustomerId || subscriptionPaymentDetails[subscription.id!].stripePaymentMethodId">
                                  <div class="col-12">
                                    <h6 class="text-muted">Stripe Information</h6>
                                    <div class="row">
                                      <div class="col-md-6"
                                        *ngIf="subscriptionPaymentDetails[subscription.id!].stripeCustomerId">
                                        <div class="mb-2">
                                          <label class="fw-medium text-muted">Stripe Customer ID:</label>
                                          <div class="font-monospace small">{{
                                            subscriptionPaymentDetails[subscription.id!].stripeCustomerId }}</div>
                                        </div>
                                      </div>
                                      <div class="col-md-6"
                                        *ngIf="subscriptionPaymentDetails[subscription.id!].stripePaymentMethodId">
                                        <div class="mb-2">
                                          <label class="fw-medium text-muted">Stripe Payment Method ID:</label>
                                          <div class="font-monospace small">{{
                                            subscriptionPaymentDetails[subscription.id!].stripePaymentMethodId }}</div>
                                        </div>
                                      </div>
                                      <div class="col-md-6"
                                        *ngIf="subscriptionPaymentDetails[subscription.id!].paymentIntentId">
                                        <div class="mb-2">
                                          <label class="fw-medium text-muted">Payment Intent ID:</label>
                                          <div class="font-monospace small">{{
                                            subscriptionPaymentDetails[subscription.id!].paymentIntentId }}</div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <!-- Error Message -->
                                <div *ngIf="subscriptionPaymentDetails[subscription.id!].error" class="mt-3">
                                  <div class="alert alert-warning">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    {{ subscriptionPaymentDetails[subscription.id!].error }}
                                  </div>
                                </div>

                                <!-- Close Button -->
                                <div class="mt-3">
                                  <button class="btn btn-outline-secondary btn-sm"
                                    (click)="togglePaymentDetails(subscription.id!)">
                                    <i class="bi bi-x-circle me-1"></i>
                                    Close Details
                                  </button>
                                </div>
                              </div>
                            </div>
                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Summary Stats -->
            <div class="row mt-4">
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-primary">{{ vendorSubscriptions.length }}</h5>
                    <p class="card-text small text-muted">Total Subscriptions</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-success">{{ getActiveSubscriptionsCount() }}</h5>
                    <p class="card-text small text-muted">Active</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-warning">{{ getTrialSubscriptionsCount() }}</h5>
                    <p class="card-text small text-muted">Trials</p>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <div class="card bg-light">
                  <div class="card-body text-center">
                    <h5 class="card-title text-danger">{{ getCancelledSubscriptionsCount() }}</h5>
                    <p class="card-text small text-muted">Cancelled</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- My Subscriptions Tab (Vendor Only) -->
      <div *ngIf="activeTab === 'my-subscriptions'" class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-wallet2 me-2"></i>
            My Subscriptions
          </h5>
        </div>
        <div class="card-body">
          <!-- Loading State -->
          <div *ngIf="subscriptionsLoading" class="text-center">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading subscription plans...</span>
            </div>
            <p class="mt-2 text-muted">Loading available subscription plans...</p>
          </div>

          <!-- No Plans -->
          <div *ngIf="!subscriptionsLoading && subscriptionPlans.length === 0" class="text-center py-4">
            <i class="bi bi-wallet2 text-muted" style="font-size: 3rem;"></i>
            <h6 class="mt-3 text-muted">No Subscription Plans Available</h6>
            <p class="text-muted">No subscription plans are currently available.</p>
          </div>

          <!-- Subscription Plans List -->
          <div *ngIf="!subscriptionsLoading && subscriptionPlans.length > 0">
            <app-travel-admin-subscription-plan [subscriptionPlans]="subscriptionPlans" [displayMode]="'vendor'"
              [activeSubscription]="activeSubscription" [vendorSubscriptions]="vendorSubscriptions"
              (planUpdated)="loadSubscriptionPlans()" (planCreated)="onPlanCreated($event)"
              (planDeleted)="onPlanDeleted($event)" (planSubscriptionRequested)="onVendorSubscriptionRequested($event)"
              (planSubscriptionCancelled)="onVendorSubscriptionCancelled($event)">
            </app-travel-admin-subscription-plan>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal fade" [class.show]="showPaymentModalFlag" [style.display]="showPaymentModalFlag ? 'block' : 'none'"
  tabindex="-1" role="dialog" [attr.aria-hidden]="!showPaymentModalFlag">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-credit-card me-2"></i>
          Complete Subscription Payment
        </h5>
        <button type="button" class="btn-close" (click)="hidePaymentModal()" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedPlanForPayment">
          <h6>Subscription Plan Details</h6>
          <div class="card bg-light mb-3">
            <div class="card-body">
              <h6 class="card-title">{{ selectedPlanForPayment.name }}</h6>
              <p class="card-text">{{ selectedPlanForPayment.description }}</p>
              <div class="d-flex justify-content-between align-items-center">
                <span class="h5 text-success mb-0">${{ selectedPlanForPayment.price | number:'1.2-2' }}</span>
                <span class="badge bg-primary">{{ selectedPlanForPayment.durationMonths }} months</span>
              </div>
            </div>
          </div>

          <app-stripe-payment-form [amount]="selectedPlanForPayment.price || 0" [currency]="'usd'"
            [description]="'Subscription: ' + (selectedPlanForPayment.name || '')" [isVisible]="showPaymentModalFlag"
            (paymentSuccess)="onPaymentSuccess($event)" (paymentError)="onPaymentError($event)"
            (paymentCancel)="onPaymentCancel()">
          </app-stripe-payment-form>
        </div>
      </div>
    </div>
  </div>
</div>