<div>
    <div class="row nogot">
        <div class="my-fluid-col main-content col mt-4 pt-2">
            <div class="row">
                <div class="col-12">
                    <div class="py-4">
                        <!-- Header -->
                        <div class="bg-primary text-white p-4 rounded mb-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h1 class="mb-0">
                                        <i class="fas fa-building me-2"></i>
                                        Insurance Company Management
                                    </h1>
                                    <p class="mb-0 opacity-75">Manage insurance companies and their access tokens</p>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button class="btn btn-light" (click)="openAddModal()">
                                        <i class="fas fa-plus me-2"></i>
                                        Add New Company
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show"
                            role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            {{ successMessage }}
                            <button type="button" class="btn-close" (click)="clearMessages()"></button>
                        </div>

                        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ errorMessage }}
                            <button type="button" class="btn-close" (click)="clearMessages()"></button>
                        </div>

                        <!-- Search and Filters -->
                        <div class="row mb-4">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" placeholder="Search insurance companies..."
                                        [(ngModel)]="searchTerm" (keyup.enter)="onSearch()">
                                    <button class="btn btn-outline-secondary" type="button" (click)="onSearch()">
                                        Search
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-info" (click)="loadInsurancers()">
                                    <i class="fas fa-refresh me-2"></i>
                                    Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Insurance Companies List -->
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Insurance Companies ({{ filteredInsurancers.length }})
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Loading State -->
                                <div *ngIf="isLoading" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-3 text-muted">Loading insurance companies...</p>
                                </div>

                                <!-- Empty State -->
                                <div *ngIf="!isLoading && filteredInsurancers.length === 0" class="text-center py-5">
                                    <i class="fas fa-building fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No insurance companies found.</p>
                                    <button class="btn btn-primary" (click)="openAddModal()">
                                        <i class="fas fa-plus me-2"></i>
                                        Add First Company
                                    </button>
                                </div>

                                <!-- Companies List -->
                                <div *ngIf="!isLoading && filteredInsurancers.length > 0" class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Company</th>
                                                <th>Contact</th>
                                                <th>Phone</th>
                                                <th>Email</th>
                                                <th>Token Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr *ngFor="let insurancer of filteredInsurancers">
                                                <td>
                                                    <div>
                                                        <strong>{{ insurancer.name }}</strong>
                                                        <br>
                                                        <small class="text-muted" *ngIf="insurancer.url">
                                                            <a [href]="insurancer.url" target="_blank"
                                                                class="text-decoration-none">
                                                                <i class="fas fa-external-link-alt me-1"></i>
                                                                {{ insurancer.url }}
                                                            </a>
                                                        </small>
                                                    </div>
                                                </td>

                                                <td>
                                                    <div>
                                                        {{ insurancer.contactFirstName }} {{ insurancer.contactLastName
                                                        }}
                                                        <br>
                                                        <small class="text-muted" *ngIf="insurancer.notes">
                                                            {{ insurancer.notes }}
                                                        </small>
                                                    </div>
                                                </td>

                                                <td>
                                                    <div>
                                                        <div *ngIf="insurancer.phone">
                                                            <i class="fas fa-phone me-1"></i>
                                                            {{ insurancer.phone }}
                                                        </div>
                                                        <div *ngIf="insurancer.phone2" class="text-muted">
                                                            <i class="fas fa-phone me-1"></i>
                                                            {{ insurancer.phone2 }}
                                                        </div>
                                                        <div *ngIf="insurancer.phone3" class="text-muted">
                                                            <i class="fas fa-phone me-1"></i>
                                                            {{ insurancer.phone3 }}
                                                        </div>
                                                    </div>
                                                </td>

                                                <td>
                                                    <a [href]="'mailto:' + insurancer.email"
                                                        class="text-decoration-none">
                                                        <i class="fas fa-envelope me-1"></i>
                                                        {{ insurancer.email }}
                                                    </a>
                                                </td>

                                                <td>
                                                    <div>
                                                        <span class="badge"
                                                            [ngClass]="insurancer.token ? 'bg-success' : 'bg-warning'">
                                                            {{ insurancer.token ? 'Token Active' : 'No Token' }}
                                                        </span>
                                                        <br>
                                                        <small class="text-muted" *ngIf="insurancer.token">
                                                            {{ getTokenDisplay(insurancer.token) }}
                                                        </small>
                                                    </div>
                                                </td>

                                                <td>
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                            (click)="openEditModal(insurancer)" title="Edit">
                                                            <i class="fas fa-edit"></i>
                                                        </button>

                                                        <button class="btn btn-sm btn-outline-success"
                                                            (click)="onRegenerateToken(insurancer)"
                                                            title="Regenerate Token" *ngIf="insurancer.token">
                                                            <i class="fas fa-key"></i>
                                                        </button>

                                                        <button class="btn btn-sm btn-outline-info"
                                                            (click)="onCopyToken(insurancer.token!)" title="Copy Token"
                                                            *ngIf="insurancer.token">
                                                            <i class="fas fa-copy"></i>
                                                        </button>

                                                        <button class="btn btn-sm btn-outline-danger"
                                                            (click)="onDelete(insurancer)" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Add/Edit Insurance Company -->
        <div class="modal fade" id="insuranceModal" tabindex="-1" aria-labelledby="insuranceModalLabel"
            aria-hidden="true" [class.show]="showModal" [style.display]="showModal ? 'block' : 'none'">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="insuranceModalLabel">
                            <i class="fas fa-edit me-2"></i>
                            {{ selectedInsurancer ? 'Edit Insurance Company' : 'Add New Insurance Company' }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" (click)="closeModal()"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form [formGroup]="insurancerForm" (ngSubmit)="selectedInsurancer ? onUpdate() : onSubmit()">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="name" class="form-label">Company Name *</label>
                                    <input type="text" class="form-control" id="name" formControlName="name"
                                        placeholder="Enter company name"
                                        [class.is-invalid]="insurancerForm.get('name')?.invalid && insurancerForm.get('name')?.touched">
                                    <div *ngIf="insurancerForm.get('name')?.invalid && insurancerForm.get('name')?.touched"
                                        class="invalid-feedback">
                                        <div *ngIf="insurancerForm.get('name')?.errors?.['required']">Company name
                                            is required</div>
                                        <div *ngIf="insurancerForm.get('name')?.errors?.['minlength']">Company name
                                            must be at least 2 characters</div>
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" formControlName="email"
                                        placeholder="Enter email address"
                                        [class.is-invalid]="insurancerForm.get('email')?.invalid && insurancerForm.get('email')?.touched">
                                    <div *ngIf="insurancerForm.get('email')?.invalid && insurancerForm.get('email')?.touched"
                                        class="invalid-feedback">
                                        <div *ngIf="insurancerForm.get('email')?.errors?.['required']">Email is
                                            required</div>
                                        <div *ngIf="insurancerForm.get('email')?.errors?.['email']">Please enter a
                                            valid email</div>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="contactFirstName" class="form-label">Contact First Name *</label>
                                    <input type="text" class="form-control" id="contactFirstName"
                                        formControlName="contactFirstName" placeholder="Enter first name"
                                        [class.is-invalid]="insurancerForm.get('contactFirstName')?.invalid && insurancerForm.get('contactFirstName')?.touched">
                                    <div *ngIf="insurancerForm.get('contactFirstName')?.invalid && insurancerForm.get('contactFirstName')?.touched"
                                        class="invalid-feedback">
                                        Contact first name is required
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="contactLastName" class="form-label">Contact Last Name *</label>
                                    <input type="text" class="form-control" id="contactLastName"
                                        formControlName="contactLastName" placeholder="Enter last name"
                                        [class.is-invalid]="insurancerForm.get('contactLastName')?.invalid && insurancerForm.get('contactLastName')?.touched">
                                    <div *ngIf="insurancerForm.get('contactLastName')?.invalid && insurancerForm.get('contactLastName')?.touched"
                                        class="invalid-feedback">
                                        Contact last name is required
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="phone" class="form-label">Primary Phone</label>
                                    <input type="tel" class="form-control" id="phone" formControlName="phone"
                                        placeholder="Enter phone number"
                                        [class.is-invalid]="insurancerForm.get('phone')?.invalid && insurancerForm.get('phone')?.touched">
                                    <div *ngIf="insurancerForm.get('phone')?.invalid && insurancerForm.get('phone')?.touched"
                                        class="invalid-feedback">
                                        Please enter a valid phone number
                                    </div>
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="phone2" class="form-label">Secondary Phone</label>
                                    <input type="tel" class="form-control" id="phone2" formControlName="phone2"
                                        placeholder="Enter secondary phone"
                                        [class.is-invalid]="insurancerForm.get('phone2')?.invalid && insurancerForm.get('phone2')?.touched">
                                </div>

                                <div class="col-md-4 mb-3">
                                    <label for="phone3" class="form-label">Tertiary Phone</label>
                                    <input type="tel" class="form-control" id="phone3" formControlName="phone3"
                                        placeholder="Enter tertiary phone"
                                        [class.is-invalid]="insurancerForm.get('phone3')?.invalid && insurancerForm.get('phone3')?.touched">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="url" class="form-label">Website URL</label>
                                    <input type="url" class="form-control" id="url" formControlName="url"
                                        placeholder="https://example.com"
                                        [class.is-invalid]="insurancerForm.get('url')?.invalid && insurancerForm.get('url')?.touched">
                                    <div *ngIf="insurancerForm.get('url')?.invalid && insurancerForm.get('url')?.touched"
                                        class="invalid-feedback">
                                        Please enter a valid URL starting with http:// or https://
                                    </div>
                                </div>

                                <div class="col-md-6 mb-3">
                                    <label for="notes" class="form-label">Notes</label>
                                    <textarea class="form-control" id="notes" formControlName="notes" rows="3"
                                        placeholder="Enter any additional notes"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeModal()">
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </button>
                        <button type="button" class="btn btn-primary"
                            [disabled]="insurancerForm.invalid || isSubmitting"
                            (click)="selectedInsurancer ? onUpdate() : onSubmit()">
                            <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
                            <i *ngIf="!isSubmitting" class="fas fa-save me-2"></i>
                            {{ selectedInsurancer ? 'Update' : 'Create' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Backdrop -->
        <div class="modal-backdrop fade show" *ngIf="showModal"></div>
    </div>
</div>