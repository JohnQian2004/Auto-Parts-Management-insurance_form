<div style="margin-left:-50px;padding:30px 10px;">
    <div class=" row nogot">
        <div class="my-fluid-col main-content col mt-4 pt-2">
            <div class="row">
                <div class="col-12">
                    <div class="py-4">
                        <!-- Header -->
                        <div class="bg-primary text-white p-4 rounded mb-4">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h1 class="mb-0">
                                        <i class="fas fa-shield-alt me-2"></i>
                                        Insurance Claim Portal
                                    </h1>
                                    <p class="mb-0 opacity-75">Secure access to vehicle claim information</p>
                                </div>
                                <div class="col-md-6 text-end">
                                    <div class="d-flex justify-content-end gap-2">
                                        <span class="badge bg-light text-dark">Company: {{ companyCode | slice:0:8
                                            }}...</span>
                                        <span class="badge bg-secondary">Vehicle: {{ publicUuid | slice:0:8 }}...</span>
                                        <span *ngIf="accessKey" class="badge bg-success">Access: {{ accessKey |
                                            slice:0:8 }}...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Error Messages -->
                        <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            {{ errorMessage }}
                            <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
                        </div>

                        <!-- Access Form Button -->
                        <div *ngIf="showAccessForm" class="row justify-content-center">
                            <div class="col-md-6 text-center">
                                <button class="btn btn-primary btn-lg" (click)="openAccessModal()">
                                    <i class="fas fa-key me-2"></i>
                                    Access Claim Information
                                </button>
                            </div>
                        </div>

                        <!-- Claim Information -->
                        <div *ngIf="isAuthenticated && !isLoading">
                            <!-- Vehicle Information -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div
                                            class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-car me-2"></i>
                                                Vehicle Information
                                            </h5>
                                            <button class="btn btn-sm btn-outline-light" (click)="openVehicleModal()">
                                                <i class="fas fa-edit me-2"></i>
                                                Edit Vehicle
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row" *ngIf="vehicle">
                                                <div class="col-md-3">
                                                    <strong>Make:</strong> {{ vehicle.make }}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Model:</strong> {{ vehicle.model }}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>Year:</strong> {{ vehicle.year }}
                                                </div>
                                                <div class="col-md-3">
                                                    <strong>VIN:</strong> {{ vehicle.vin }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Insurance Estimate Details -->
                            <!-- <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-warning text-dark">
                                            <h5 class="mb-0">
                                                <i class="fas fa-file-alt me-2"></i>
                                                Insurance Estimate Details
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div *ngIf="insuranceClaims.length === 0" class="text-center text-muted">
                                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                                <p>No Insurance Estimate Details found for this vehicle.</p>
                                            </div>

                                            <div *ngFor="let claim of insuranceClaims"
                                                class="claim-item border-bottom pb-3 mb-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-3">
                                                        <span class="badge"
                                                            [ngClass]="getStatusClass(claim.status || '')">
                                                            {{ claim.status || 'UNKNOWN' }}
                                                        </span>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Claim #:</strong> {{ claim.claimNumber || 'N/A' }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Date:</strong> {{ claim.claimDate | date:'shortDate' }}
                                                    </div>
                                                    <div class="col-md-3">
                                                        <strong>Updated:</strong> {{ claim.lastUpdated |
                                                        date:'shortDate' }}
                                                    </div>
                                                </div>
                                                <div class="row mt-2" *ngIf="claim.comments">
                                                    <div class="col-12">
                                                        <strong>Comments:</strong> {{ claim.comments }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> -->

                            <!-- Collision Damage Gallery -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                                            <div>
                                                <h5 class="mb-0">
                                                    <i class="fas fa-car-crash me-2"></i>
                                                    Collision Damage Gallery
                                                </h5>
                                                <small class="text-white-50">Click on any image to view full size with
                                                    details</small>
                                            </div>
                                            <button class="btn btn-light btn-sm" (click)="openAnnotationModal()" title="Add New Image with Annotation">
                                                <i class="fas fa-plus me-1"></i> Add Image
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div *ngFor="let image of collisionImages"
                                                    class="col-md-6 col-lg-4 col-xl-3">
                                                    <div class="card h-100 shadow-sm"
                                                        style="transition: transform 0.3s ease;"
                                                        onmouseover="this.style.transform='translateY(-5px)'"
                                                        onmouseout="this.style.transform='translateY(0)'">
                                                        <div class="evidence-card">
                                                            <div class="evidence-image"
                                                                [style.background-image]="'url(' + image.thumbnailUrl + ')'">
                                                                <div class="severity-badge">
                                                                    <span [ngClass]="getSeverityClass(image.severity)">
                                                                        {{ image.severity }}
                                                                    </span>
                                                                </div>
                                                                <div class="image-overlay">
                                                                    <button class="btn btn-light btn-sm me-1"
                                                                        (click)="openImageModal(image)">
                                                                        <i class="fas fa-eye"></i>
                                                                    </button>
                                                                    <button class="btn btn-warning btn-sm me-1"
                                                                        (click)="editGalleryImage(image)"
                                                                        title="Edit Image">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    <button class="btn btn-danger btn-sm"
                                                                        (click)="deleteGalleryImage(image)"
                                                                        title="Remove Image">
                                                                        <i class="fas fa-trash"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                            <div class="evidence-info">
                                                                <small class="text-muted fw-bold">{{ image.damageType
                                                                    }}</small>
                                                                <p class="evidence-description mb-1">{{
                                                                    image.description }}</p>
                                                                <small class="text-muted">{{ image.timestamp | date:'MMM
                                                                    d, y h:mm a' }}</small>
                                                            </div>
                                                        </div>

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Claims Form Section -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div
                                            class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-edit me-2"></i>
                                                Claims Form
                                            </h5>
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-light" (click)="printClaimsForm()"
                                                    title="Print Claims Form">
                                                    <i class="fas fa-print me-1"></i>
                                                    Print
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning"
                                                    (click)="downloadClaimAsZip()" title="Download All Files as Zip">
                                                    <i class="fas fa-file-archive me-1"></i>
                                                    Download as Zip
                                                </button>
                                                <button class="btn btn-sm btn-outline-light"
                                                    (click)="exportClaimsToPDF()" title="Export Claims to PDF">
                                                    <i class="fas fa-file-pdf me-1"></i>
                                                    PDF
                                                </button>
                                                <button class="btn btn-sm btn-outline-light"
                                                    (click)="openClaimsModal()">
                                                    <i class="fas fa-edit me-2"></i>
                                                    {{ isFormEditable ? 'Edit Form' : 'View Form' }}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <strong>Claim Number:</strong> {{
                                                    claimsForm.get('claimNumber')?.value || 'N/A' }}
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Policy Number:</strong> {{
                                                    claimsForm.get('policyNumber')?.value || 'N/A' }}
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <strong>Status:</strong>
                                                    <span class="badge"
                                                        [ngClass]="getStatusClass(claimsForm.get('status')?.value)">
                                                        {{ claimsForm.get('status')?.value || 'N/A' }}
                                                    </span>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Priority:</strong> {{ claimsForm.get('priority')?.value ||
                                                    'N/A' }}
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-12">
                                                    <strong>Damage Description:</strong> {{
                                                    claimsForm.get('damageDescription')?.value || 'N/A' }}
                                                </div>
                                            </div>
                                            <div class="row mt-3">
                                                <div class="col-md-6">
                                                    <strong>Estimated Cost:</strong> ${{
                                                    claimsForm.get('estimatedCost')?.value || '0' }}
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>Actual Cost:</strong> ${{
                                                    claimsForm.get('actualCost')?.value || '0' }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Shop Information Card -->
                            <div class="card shadow-sm border-0 mb-4" *ngIf="estimateData">
                                <div
                                    class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-building me-2"></i>
                                        {{ estimateData.shopInfo?.invoiceType || 'Shop Information' }}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <!-- Shop Header with Logo, Info, and Workfile ID (3 columns) -->
                                    <div class="row mb-4">
                                        <!-- Column 1: Logo -->
                                        <div class="col-md-3 text-center">
                                            <div class="shop-logo-container">
                                                <div class="shop-logo">
                                                    <div class="logo-circle">
                                                        <div class="logo-icon">
                                                            <i class="fas fa-wrench"></i>
                                                            <i class="fas fa-car"></i>
                                                        </div>
                                                    </div>
                                                    <div class="logo-text">
                                                        <div class="logo-primary">AUTO POINT</div>
                                                        <div class="logo-secondary">COLLISION REPAIRS</div>
                                                        <div class="logo-tertiary">& CAR PAINT</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Column 2: Shop Information -->
                                        <div class="col-md-6">
                                            <div class="shop-info">
                                                <h4 class="text-primary fw-bold mb-2">{{ estimateData.shopInfo?.name }}
                                                </h4>
                                                <p class="mb-1 text-muted small">{{ estimateData.shopInfo?.description
                                                    }}</p>
                                                <p class="mb-1"><i class="fas fa-map-marker-alt me-2 text-danger"></i>{{
                                                    estimateData.shopInfo?.address }}</p>
                                                <p class="mb-0"><i class="fas fa-phone me-2 text-success"></i>{{
                                                    estimateData.shopInfo?.phone }}</p>
                                            </div>
                                        </div>

                                        <!-- Column 3: Workfile ID and PartsShare -->
                                        <div class="col-md-3">
                                            <div class="workfile-info">
                                                <div class="mb-2">
                                                    <label class="small text-muted fw-bold">Workfile ID:</label>
                                                    <div class="fw-bold">{{ estimateData.shopInfo?.workfileId }}</div>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="small text-muted fw-bold">PartsShare:</label>
                                                    <div class="fw-bold">{{ estimateData.shopInfo?.partsShare }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="my-4">

                                    <!-- Preliminary Estimate Header -->
                                    <div class="text-center mb-4">
                                        <h3 class="text-primary fw-bold">Preliminary Estimate</h3>
                                    </div>

                                    <hr class="my-4">

                                    <!-- Customer Information Section -->
                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <h5 class="text-secondary mb-3"><i class="fas fa-user me-2"></i>Customer
                                                Information</h5>
                                            <div class="customer-info">
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Customer:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.customerInfo?.name }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Phone:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.customerInfo?.phone }} ({{
                                                        estimateData.customerInfo?.phoneType }})</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Owner:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.customerInfo?.name }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Insured:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.customerInfo?.name }}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <h5 class="text-secondary mb-3"><i
                                                    class="fas fa-clipboard-list me-2"></i>Job
                                                Information</h5>
                                            <div class="job-info">
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Job Number:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.jobNumber || 'TBD' }}
                                                    </div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Written By:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.writtenBy }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Adjuster:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.adjuster }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Claim #:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.claimNumber }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-6">
                                            <div class="additional-info">
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Policy #:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.policyNumber || 'TBD'
                                                        }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Type of Loss:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.typeOfLoss || 'TBD'
                                                        }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Date of Loss:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.dateOfLoss || 'TBD'
                                                        }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Days to Repair:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.daysToRepair }}</div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="col-md-6">
                                            <div class="location-info">
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Point of Impact:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.pointOfImpact ||
                                                        'TBD' }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Inspection Location:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.jobInfo?.inspectionLocation }}
                                                    </div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Insurance Company:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.insuranceInfo?.company }}
                                                    </div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Repair Facility:</strong></div>
                                                    <div class="col-sm-8">{{ estimateData.repairFacility?.name }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="my-4">

                                    <!-- Customer Information from Vehicle Object -->
                                    <div class="row mb-4" *ngIf="vehicle && vehicle.customer">
                                        <div class="col-md-6">
                                            <h5 class="text-secondary mb-3"><i class="fas fa-user me-2"></i>CUSTOMER FROM VEHICLE</h5>
                                            <div class="customer-info-from-vehicle">
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Name:</strong></div>
                                                    <div class="col-sm-8">{{ vehicle.customer.title }} {{ vehicle.customer.firstName }} {{ vehicle.customer.lastName }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Phone:</strong></div>
                                                    <div class="col-sm-8">{{ formatPhoneNumber(vehicle.customer.phone) }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Email:</strong></div>
                                                    <div class="col-sm-8">{{ vehicle.customer.email }}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h5 class="text-secondary mb-3">&nbsp;</h5> <!-- Spacing header -->
                                            <div class="address-info-from-vehicle">
                                                <div class="row mb-2">
                                                    <div class="col-sm-4"><strong>Address:</strong></div>
                                                    <div class="col-sm-8">{{ vehicle.customer.street }}, {{ vehicle.customer.city }}, {{ vehicle.customer.state }} {{ vehicle.customer.zip }}</div>
                                                </div>
                                                <div class="row mb-2" *ngIf="vehicle.customer.notes">
                                                    <div class="col-sm-4"><strong>Notes:</strong></div>
                                                    <div class="col-sm-8">{{ vehicle.customer.notes }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Vehicle Section (4 columns) -->
                                    <h5 class="text-secondary mb-3"><i class="fas fa-car me-2"></i>VEHICLE</h5>
                                    <div class="vehicle-info mb-4">
                                        <div class="row mb-3">
                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Year:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.year }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Make:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.make }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Model:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.model }}</div>
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Body Style:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.bodyStyle }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Engine:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.engine }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Color:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.color }}</div>
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>VIN:</strong></div>
                                                    <div class="col-12 small">{{ estimateData.vehicleInfo?.vin }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Interior Color:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.interiorColor ||
                                                        'TBD' }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Exterior Color:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.exteriorColor }}
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Mileage In:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.mileageIn || 'TBD'
                                                        }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Mileage Out:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.mileageOut || 'TBD'
                                                        }}</div>
                                                </div>
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>License:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.license || 'TBD' }}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>State:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.state }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Production Date:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.productionDate ||
                                                        'TBD' }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Condition:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.condition || 'TBD'
                                                        }}</div>
                                                </div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="row mb-2">
                                                    <div class="col-12"><strong>Job #:</strong></div>
                                                    <div class="col-12">{{ estimateData.vehicleInfo?.jobNumber || 'TBD'
                                                        }}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <hr class="my-4">
                                </div>
                            </div>

                            <!-- Insurance Estimate Details Card -->
                            <div class="card shadow-sm border-0 mb-4" *ngIf="estimateData">
                                <div
                                    class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-calculator me-2"></i>
                                        Insurance Estimate Details
                                    </h5>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-success" *ngIf="isEstimateEditable"
                                            (click)="addNewArea()" title="Add New Area">
                                            <i class="fas fa-plus me-1"></i>
                                            Add New Area
                                        </button>
                                        <button class="btn btn-sm btn-outline-primary" (click)="printEstimateTable()"
                                            title="Print Estimate">
                                            <i class="fas fa-print me-1"></i>
                                            Print
                                        </button>
                                        <button class="btn btn-sm btn-outline-warning" (click)="downloadClaimAsZip()"
                                            title="Download All Files as Zip">
                                            <i class="fas fa-file-archive me-1"></i>
                                            Download as Zip
                                        </button>
                                        <button class="btn btn-sm btn-outline-success" (click)="exportEstimateToPDF()"
                                            title="Export to PDF">
                                            <i class="fas fa-file-pdf me-1"></i>
                                            PDF Export
                                        </button>
                                        <button class="btn btn-sm btn-outline-info" (click)="testEstimateData()"
                                            title="Test Data">
                                            <i class="fas fa-bug me-1"></i>
                                            Test Data
                                        </button>
                                        <button class="btn btn-sm btn-outline-dark" (click)="toggleEstimateEdit()">
                                            <i class="fas" [ngClass]="isEstimateEditable ? 'fa-lock' : 'fa-unlock'"></i>
                                            {{ isEstimateEditable ? 'Lock Estimate' : 'Unlock Estimate' }}
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-bordered table-hover mb-0">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th class="text-center">Line</th>
                                                    <th class="text-center">Oper</th>
                                                    <th class="text-center">Description</th>
                                                    <!-- <th class="text-center">Part Number</th> -->
                                                    <th class="text-center">OEM Number</th>
                                                    <th class="text-center">Qty</th>
                                                    <th class="text-center">Extended</th>
                                                    <th class="text-center">Labor</th>
                                                    <th class="text-center">Paint</th>
                                                    <th class="text-center" *ngIf="isEstimateEditable">Actions
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- ===== USING ORIGINAL DATA STRUCTURE FOR PROPER BINDING ===== -->
                                                <ng-container *ngIf="estimateData">
                                                    <ng-container
                                                        *ngFor="let area of estimateData.estimateData; let areaIndex = index">
                                                        <!-- Area Header -->
                                                        <tr class="table-secondary fw-bold">
                                                            <td class="text-center">{{ getAreaLineNumber(areaIndex) }}
                                                            </td>
                                                            <td colspan="7" class="text-center">{{ area.areaName }}</td>
                                                            <td class="text-center" *ngIf="isEstimateEditable">
                                                                <div class="btn-group btn-group-sm">
                                                                    <button class="btn btn-outline-success"
                                                                        (click)="addLineToArea(areaIndex)"
                                                                        title="Add New Line to Area"
                                                                        [disabled]="!isEstimateEditable">
                                                                        <i class="fas fa-plus"></i>
                                                                    </button>
                                                                    <button class="btn btn-outline-warning"
                                                                        (click)="editArea(areaIndex)" title="Edit Area"
                                                                        [disabled]="!isEstimateEditable">
                                                                        <i class="fas fa-edit"></i>
                                                                    </button>
                                                                    <button class="btn btn-outline-info"
                                                                        (click)="toggleEvidenceRow(getAreaLineNumber(areaIndex))"
                                                                        title="View Area Photos ({{ area.images?.length }})"
                                                                        [disabled]="!isEstimateEditable">
                                                                        <i class="fas fa-camera"></i>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>

                                                        <!-- Area Evidence Gallery Row -->
                                                        <tr *ngIf="isRowExpanded(getAreaLineNumber(areaIndex))"
                                                            class="evidence-gallery-row">
                                                            <td colspan="10" class="p-0">
                                                                <div class="evidence-gallery-container bg-light">
                                                                    <div class="p-3">
                                                                        <h6
                                                                            class="mb-3 d-flex justify-content-between align-items-center">
                                                                            <span>
                                                                                <i
                                                                                    class="fas fa-camera me-2 text-info"></i>
                                                                                Evidence Photos for {{ area.areaName }}
                                                                                ({{ area.images?.length || 0 }})
                                                                            </span>
                                                                            <button class="btn btn-success btn-sm"
                                                                                (click)="addRandomPhotosToArea(areaIndex)"
                                                                                title="Add Random Photos">
                                                                                <i class="fas fa-plus"></i>
                                                                            </button>
                                                                        </h6>
                                                                        <div class="row"
                                                                            *ngIf="area.images && area.images.length > 0">
                                                                            <div *ngFor="let image of area.images"
                                                                                class="col-md-3 col-sm-4 col-6 mb-3">
                                                                                <div class="evidence-card">
                                                                                    <div class="evidence-image"
                                                                                        [style.background-image]="'url(' + image.thumbnailUrl + ')'">
                                                                                        <div class="severity-badge">
                                                                                            <span
                                                                                                [ngClass]="getSeverityClass(image.severity)">
                                                                                                {{ image.severity }}
                                                                                            </span>
                                                                                        </div>
                                                                                        <div class="image-overlay">
                                                                                            <button
                                                                                                class="btn btn-light btn-sm me-1"
                                                                                                (click)="openImageModal(image)">
                                                                                                <i
                                                                                                    class="fas fa-eye"></i>
                                                                                            </button>
                                                                                            <button
                                                                                                class="btn btn-warning btn-sm me-1"
                                                                                                (click)="openImageEditor(areaIndex, image)"
                                                                                                title="Edit Image">
                                                                                                <i
                                                                                                    class="fas fa-edit"></i>
                                                                                            </button>
                                                                                            <button
                                                                                                class="btn btn-danger btn-sm"
                                                                                                (click)="removeImageFromArea(areaIndex, image.id)"
                                                                                                title="Remove Image">
                                                                                                <i
                                                                                                    class="fas fa-trash"></i>
                                                                                            </button>
                                                                                        </div>
                                                                                    </div>
                                                                                    <div class="evidence-info">
                                                                                        <small
                                                                                            class="text-muted fw-bold">{{
                                                                                            image.damageType }}</small>
                                                                                        <p
                                                                                            class="evidence-description mb-1">
                                                                                            {{
                                                                                            image.description }}</p>
                                                                                        <small class="text-muted">{{
                                                                                            image.timestamp | date:'MMM
                                                                                            d,
                                                                                            y h:mm a' }}</small>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        <div class="text-center text-muted py-4"
                                                                            *ngIf="!area.images || area.images.length === 0">
                                                                            <i
                                                                                class="fas fa-camera fa-3x mb-3 opacity-50"></i>
                                                                            <p>No evidence photos for this area yet.</p>
                                                                            <p class="small">Click the <i
                                                                                    class="fas fa-plus text-success"></i>
                                                                                button above to add photos.</p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                        </tr>

                                                        <!-- Item Rows -->
                                                        <ng-container
                                                            *ngFor="let item of area.claimItems; let itemIndex = index">
                                                            <tr [ngClass]="{'table-warning': item.note}">
                                                                <td class="text-center">{{ getItemLineNumber(areaIndex,
                                                                    itemIndex) }}</td>
                                                                <td class="text-center">{{ item.operation }}</td>
                                                                <td>
                                                                    {{ item.description }}
                                                                    <div *ngIf="item.note" class="text-warning small">
                                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                                        <strong>NOTE:</strong> {{ item.note }}
                                                                    </div>
                                                                </td>
                                                                <!-- <td class="text-center">{{ item.partNumber || '-' }}
                                                                </td> -->
                                                                <td class="text-center">{{ item.oemNumber || '-' }}</td>
                                                                <td class="text-center">{{ item.quantity || '-' }}</td>
                                                                <td class="text-center">{{ item.extendedPrice ? '$' +
                                                                    item.extendedPrice : '-' }}</td>
                                                                <td class="text-center">{{ item.laborHours || '-' }}
                                                                </td>
                                                                <td class="text-center">{{ item.paintHours || '-' }}
                                                                </td>
                                                                <td class="text-center" *ngIf="isEstimateEditable">
                                                                    <div class="btn-group btn-group-sm" role="group">
                                                                        <button class="btn btn-outline-primary btn-sm"
                                                                            (click)="addLineAfter(getItemLineNumber(areaIndex, itemIndex))"
                                                                            title="Add Line After"
                                                                            [disabled]="!isEstimateEditable">
                                                                            <i class="fas fa-plus"></i>
                                                                        </button>
                                                                        <button class="btn btn-outline-warning btn-sm"
                                                                            (click)="editLine(getItemLineNumber(areaIndex, itemIndex))"
                                                                            title="Edit Line"
                                                                            [disabled]="!isEstimateEditable">
                                                                            <i class="fas fa-edit"></i>
                                                                        </button>
                                                                        <button class="btn btn-outline-danger btn-sm"
                                                                            (click)="deleteLine(getItemLineNumber(areaIndex, itemIndex))"
                                                                            title="Delete Line"
                                                                            [disabled]="!isEstimateEditable">
                                                                            <i class="fas fa-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        </ng-container>
                                                    </ng-container>
                                                </ng-container>

                                                <!-- Summary Row -->
                                                <tr class="table-primary fw-bold">
                                                    <td colspan="5" class="text-center">
                                                        <strong>SUBTOTALS</strong>
                                                    </td>
                                                    <td class="text-center"><strong>${{
                                                            estimateData.summary.subtotal }}</strong></td>
                                                    <td class="text-center"><strong>{{
                                                            estimateData.summary.laborHours }}</strong></td>
                                                    <td class="text-center"><strong>{{
                                                            estimateData.summary.paintHours }}</strong></td>
                                                    <td class="text-center" *ngIf="isEstimateEditable">
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button class="btn btn-outline-primary btn-sm"
                                                                (click)="addLineAfter(0)" title="Add Line After"
                                                                [disabled]="!isEstimateEditable">
                                                                <i class="fas fa-plus"></i>
                                                            </button>
                                                            <button class="btn btn-outline-warning btn-sm"
                                                                (click)="editLine(0)" title="Edit Line"
                                                                [disabled]="!isEstimateEditable">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger btn-sm"
                                                                (click)="deleteLine(0)" title="Delete Line"
                                                                [disabled]="!isEstimateEditable">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>


                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Debug Log Panel -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div
                                            class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="fas fa-terminal me-2"></i>
                                                CRUD Debug Log
                                            </h5>
                                            <button class="btn btn-sm btn-outline-light" (click)="clearDebugLog()">
                                                <i class="fas fa-trash me-2"></i>Clear Log
                                            </button>
                                        </div>
                                        <div class="card-body p-0">
                                            <div class="debug-log-container"
                                                style="max-height: 300px; overflow-y: auto;">
                                                <div *ngFor="let log of debugLogs"
                                                    class="debug-log-entry p-2 border-bottom">
                                                    <div class="d-flex justify-content-between align-items-start">
                                                        <div class="flex-grow-1">
                                                            <span class="badge me-2"
                                                                [ngClass]="getLogLevelClass(log.level)">
                                                                {{ log.level }}
                                                            </span>
                                                            <span class="text-muted">{{ log.timestamp | date:'HH:mm:ss'
                                                                }}</span>
                                                            <strong class="ms-2">{{ log.action }}</strong>
                                                            <span class="ms-2">{{ log.details }}</span>
                                                        </div>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                            (click)="copyLogToClipboard(log)" title="Copy to clipboard">
                                                            <i class="fas fa-copy"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div *ngIf="debugLogs.length === 0" class="text-center text-muted p-3">
                                                    <i class="fas fa-info-circle fa-2x mb-2"></i>
                                                    <p>No CRUD operations logged yet. Start editing the estimate to see
                                                        activity.</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Documents Section -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="mb-0">
                                                <i class="fas fa-folder-open me-2"></i>
                                                Documents & Files
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <!-- Upload Section -->
                                            <div class="upload-section mb-4 p-3 bg-light rounded">
                                                <h6 class="mb-3">
                                                    <i class="fas fa-upload me-2"></i>
                                                    Upload New Documents
                                                </h6>
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <input type="file" class="form-control" multiple
                                                            (change)="onFileSelected($event)"
                                                            accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.bmp,.tiff">
                                                        <small class="form-text text-muted">
                                                            Supported formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG, GIF,
                                                            BMP, TIFF
                                                        </small>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <button class="btn btn-success w-100"
                                                            (click)="uploadDocuments()"
                                                            [disabled]="selectedFiles.length === 0 || isUploading">
                                                            <span *ngIf="isUploading"
                                                                class="spinner-border spinner-border-sm me-2"></span>
                                                            <i *ngIf="!isUploading" class="fas fa-upload me-2"></i>
                                                            {{ isUploading ? 'Uploading...' : 'Upload' }}
                                                        </button>
                                                    </div>
                                                </div>

                                                <!-- Upload Progress -->
                                                <div *ngIf="isUploading" class="mt-3">
                                                    <div class="progress">
                                                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                            [style.width.%]="uploadProgress"></div>
                                                    </div>
                                                    <small class="text-muted">{{ uploadProgress }}% Complete</small>
                                                </div>
                                            </div>

                                            <!-- Documents List -->
                                            <div *ngIf="documents.length === 0" class="text-center text-muted">
                                                <i class="fas fa-folder fa-3x mb-3"></i>
                                                <p>No documents uploaded yet.</p>
                                            </div>

                                            <div *ngFor="let doc of documents"
                                                class="document-item border rounded p-3 mb-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-2">
                                                        <i class="fas fa-file-alt fa-2x text-primary"></i>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <strong>{{ doc.fileName }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ doc.docTypeName || 'Unknown Type'
                                                            }}</small>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <small class="text-muted">
                                                            Uploaded: {{ doc.createdAt | date:'shortDate' }}
                                                        </small>
                                                    </div>
                                                    <div class="col-md-3 text-end">
                                                        <button class="btn btn-sm btn-outline-primary me-2"
                                                            (click)="downloadDocument(doc)" title="Download">
                                                            <i class="fas fa-download"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger"
                                                            (click)="deleteDocument(doc)" title="Delete">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="row mt-2" *ngIf="doc.description">
                                                    <div class="col-12">
                                                        <small class="text-muted">{{ doc.description }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="row mb-4">
                                <div class="col-12 text-center">
                                    <button class="btn btn-outline-secondary me-3" (click)="resetForm()">
                                        <i class="fas fa-refresh me-2"></i>
                                        Reset Session
                                    </button>
                                    <button class="btn btn-outline-info" (click)="printPage()">
                                        <i class="fas fa-print me-2"></i>
                                        Print Report
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Loading State -->
                        <div *ngIf="isLoading" class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading claim information...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Modal -->
        <div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'"
            tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-edit me-2"></i>
                            {{ isEditingLine ? 'Edit Line ' + editingLine?.lineNumber : 'Add New Line' }}
                        </h5>
                        <button type="button" class="btn-close" (click)="closeEditModal()"></button>
                    </div>
                    <div class="modal-body">
                        <div class="container-fluid">
                            <form [formGroup]="estimateLineForm" (ngSubmit)="saveEstimateLine()">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Line Number</label>
                                        <input type="number" class="form-control" formControlName="lineNumber"
                                            [readonly]="isEditingLine">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Operation</label>
                                        <select class="form-select" formControlName="operation">
                                            <option value="R&I">R&I (Remove & Install)</option>
                                            <option value="Repl">Repl (Replace)</option>
                                            <option value="Blnd">Blnd (Blend)</option>
                                            <option value="Add">Add</option>
                                            <option value="LT">LT (Left Transfer)</option>
                                            <option value="RT">RT (Right Transfer)</option>
                                            <option value="Rpr">Rpr (Repair)</option>
                                            <option value="Subl">Subl (Sublet)</option>
                                            <option value="Cover">Cover</option>
                                        </select>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label fw-bold">Description</label>
                                        <textarea class="form-control" rows="2"
                                            formControlName="description"></textarea>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Part Number</label>
                                        <input type="text" class="form-control" formControlName="partNumber"
                                            placeholder="e.g., DS7Z5410177A">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Quantity</label>
                                        <input type="number" class="form-control" formControlName="quantity" step="0.1"
                                            min="0">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Extended Price ($)</label>
                                        <input type="number" class="form-control" formControlName="extendedPrice"
                                            step="0.01" min="0" placeholder="0.00">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Labor Hours</label>
                                        <input type="number" class="form-control" formControlName="laborHours"
                                            step="0.1" min="0" placeholder="0.0">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Paint Hours</label>
                                        <input type="number" class="form-control" formControlName="paintHours"
                                            step="0.1" min="0" placeholder="0.0">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Area</label>
                                        <select class="form-select" formControlName="area">
                                            <option value="PILLARS, ROCKER & FLOOR">PILLARS, ROCKER & FLOOR
                                            </option>
                                            <option value="FRONT DOOR">FRONT DOOR</option>
                                            <option value="REAR DOOR">REAR DOOR</option>
                                            <option value="QUARTER PANEL">QUARTER PANEL</option>
                                            <option value="REAR LAMPS">REAR LAMPS</option>
                                            <option value="REAR BUMPER">REAR BUMPER</option>
                                            <option value="MISCELLANEOUS OPERATIONS">MISCELLANEOUS OPERATIONS
                                            </option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Form Actions -->
                                <div class="row mt-4 pt-3 border-top">
                                    <div class="col-12 d-flex justify-content-between">
                                        <button type="button" class="btn btn-outline-secondary"
                                            (click)="closeEditModal()">
                                            <i class="fas fa-times me-2"></i>Cancel
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>{{ isEditingLine ? 'Update Line' :
                                            'Add Line' }}
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Area Editor Modal -->
        <div class="modal fade" [class.show]="showAreaModal" [style.display]="showAreaModal ? 'block' : 'none'"
            tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-cog me-2"></i>
                            {{ isEditingArea ? 'Edit Area' : 'Add New Area' }}
                        </h5>
                        <button type="button" class="btn-close" (click)="closeAreaModal()"></button>
                    </div>
                    <div class="modal-body">
                        <form [formGroup]="areaForm" (ngSubmit)="saveArea()">
                            <div class="row g-3">
                                <!-- Show dropdown only when editing existing area -->
                                <div class="col-12" *ngIf="isEditingArea">
                                    <label class="form-label fw-bold">Area Name</label>
                                    <select class="form-select" formControlName="areaName">
                                        <option value="">Select an area...</option>
                                        <option value="PILLARS, ROCKER & FLOOR">PILLARS, ROCKER & FLOOR</option>
                                        <option value="FRONT DOOR">FRONT DOOR</option>
                                        <option value="REAR DOOR">REAR DOOR</option>
                                        <option value="QUARTER PANEL">QUARTER PANEL</option>
                                        <option value="REAR LAMPS">REAR LAMPS</option>
                                        <option value="REAR BUMPER">REAR BUMPER</option>
                                        <option value="FRONT BUMPER">FRONT BUMPER</option>
                                        <option value="HOOD">HOOD</option>
                                        <option value="FENDER">FENDER</option>
                                        <option value="ROOF">ROOF</option>
                                        <option value="WINDSHIELD">WINDSHIELD</option>
                                        <option value="SIDE MIRROR">SIDE MIRROR</option>
                                        <option value="HEADLIGHTS">HEADLIGHTS</option>
                                        <option value="TAILLIGHTS">TAILLIGHTS</option>
                                        <option value="MISCELLANEOUS OPERATIONS">MISCELLANEOUS OPERATIONS</option>
                                    </select>
                                </div>
                                <!-- Show custom name input when editing -->
                                <div class="col-12" *ngIf="isEditingArea">
                                    <label class="form-label fw-bold">Custom Area Name</label>
                                    <input type="text" class="form-control" formControlName="customAreaName"
                                        placeholder="Or enter a custom area name...">
                                    <small class="form-text text-muted">Leave empty to use the selected area name
                                        above</small>
                                </div>
                                <!-- Show text input when adding new area -->
                                <div class="col-12" *ngIf="!isEditingArea">
                                    <label class="form-label fw-bold">New Area Name</label>
                                    <input type="text" class="form-control" formControlName="customAreaName"
                                        placeholder="Enter the name for the new area..."
                                        [class.is-invalid]="areaForm.get('customAreaName')?.invalid && areaForm.get('customAreaName')?.touched">
                                    <div class="invalid-feedback">
                                        Area name is required
                                    </div>
                                    <small class="form-text text-muted">Enter a descriptive name for this damage
                                        area</small>
                                </div>
                                <div class="col-12">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" rows="3" formControlName="description"
                                        placeholder="Optional description for this area..."></textarea>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="row mt-4 pt-3 border-top">
                                <div class="col-12 d-flex justify-content-between">
                                    <button type="button" class="btn btn-outline-secondary" (click)="closeAreaModal()">
                                        <i class="fas fa-times me-2"></i>Cancel
                                    </button>
                                    <div>
                                        <button type="button" class="btn btn-outline-danger me-2" *ngIf="isEditingArea"
                                            (click)="deleteArea()">
                                            <i class="fas fa-trash me-2"></i>Delete Area
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i>{{ isEditingArea ? 'Update Area' : 'Add
                                            Area' }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Modal Popup -->
        <div class="modal fade" [class.show]="showImageModal" [style.display]="showImageModal ? 'block' : 'none'"
            tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-car-crash me-2"></i>
                            {{ selectedImage?.damageType }} - Damage Details
                        </h5>
                        <button type="button" class="btn-close" (click)="closeImageModal()"></button>
                    </div>
                    <div class="modal-body p-0">
                        <div class="row g-0 h-100 damage-details-container">
                            <!-- Image Section - Full Height -->
                            <div class="col-md-8 position-relative">
                                <div class="damage-image-container">
                                    <img [src]="selectedImage?.imageUrl" [alt]="selectedImage?.damageType"
                                        class="damage-detail-image">
                                    <!-- Severity Badge Overlay -->
                                    <div class="position-absolute top-0 start-0 m-3">
                                        <span class="badge fs-6 px-3 py-2"
                                            [ngClass]="getSeverityClass(selectedImage?.severity)">
                                            <i class="fas fa-exclamation-triangle me-2"></i>{{ selectedImage?.severity
                                            }}
                                        </span>
                                    </div>
                                    <!-- Cost Badge Overlay -->
                                    <div class="position-absolute top-0 end-0 m-3">
                                        <span class="badge bg-success fs-6 px-3 py-2">
                                            <i class="fas fa-dollar-sign me-1"></i>{{
                                            selectedImage?.estimatedRepairCost?.toLocaleString() }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Information Panel -->
                            <div class="col-md-4 bg-light">
                                <div class="damage-info-panel p-4 h-100">
                                    <!-- Header -->
                                    <div class="mb-4">
                                        <h5 class="text-primary mb-2">
                                            <i class="fas fa-info-circle me-2"></i>Damage Information
                                        </h5>
                                        <hr class="text-primary">
                                    </div>

                                    <!-- Damage Type -->
                                    <div class="info-item mb-3">
                                        <div class="info-label">
                                            <i class="fas fa-tag me-2 text-warning"></i>Damage Type
                                        </div>
                                        <div class="info-value fw-bold">{{ selectedImage?.damageType }}</div>
                                    </div>

                                    <!-- Location -->
                                    <div class="info-item mb-3">
                                        <div class="info-label">
                                            <i class="fas fa-map-marker-alt me-2 text-danger"></i>Location
                                        </div>
                                        <div class="info-value">{{ selectedImage?.location }}</div>
                                    </div>

                                    <!-- Incident Date -->
                                    <div class="info-item mb-3">
                                        <div class="info-label">
                                            <i class="fas fa-calendar me-2 text-info"></i>Incident Date
                                        </div>
                                        <div class="info-value">{{ selectedImage?.timestamp | date:'MMM dd, yyyy' }}
                                        </div>
                                    </div>

                                    <!-- Description -->
                                    <div class="info-item mb-3">
                                        <div class="info-label">
                                            <i class="fas fa-file-alt me-2 text-secondary"></i>Description
                                        </div>
                                        <div class="info-value text-muted">{{ selectedImage?.description }}</div>
                                    </div>

                                    <!-- File Info -->
                                    <div class="info-item mb-3">
                                        <div class="info-label">
                                            <i class="fas fa-file-image me-2 text-secondary"></i>File Name
                                        </div>
                                        <div class="info-value small text-break">{{ selectedImage?.fileName }}</div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="mt-auto pt-3">
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm"
                                                (click)="downloadDamageImage()">
                                                <i class="fas fa-download me-2"></i>Download Image
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm"
                                                (click)="printDamageDetails()">
                                                <i class="fas fa-print me-2"></i>Print Details
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Backdrop -->
        <div class="modal-backdrop fade show"
            *ngIf="showEditModal || showImageModal || showAccessModal || showClaimsModal || showVehicleModal || showImageEditor || showAreaModal">
        </div>

        <!-- Access Modal -->
        <div class="modal fade" [class.show]="showAccessModal" [style.display]="showAccessModal ? 'block' : 'none'"
            tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-key me-2"></i>
                            Access Authentication
                        </h5>
                        <button type="button" class="btn-close btn-close-white" (click)="closeAccessModal()"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form [formGroup]="accessForm" (ngSubmit)="onSubmit()">
                            <div class="mb-3">
                                <label for="privateKey" class="form-label">
                                    Private Access Key
                                    <span class="badge bg-success ms-2">Pre-filled Demo Key</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-key"></i>
                                    </span>
                                    <input type="text" class="form-control" id="privateKey" formControlName="privateKey"
                                        placeholder="Enter any text (e.g., demo123, test, etc.)"
                                        [class.is-invalid]="accessForm.get('privateKey')?.invalid && accessForm.get('privateKey')?.touched">
                                </div>
                                <div *ngIf="accessForm.get('privateKey')?.invalid && accessForm.get('privateKey')?.touched"
                                    class="invalid-feedback">
                                    <div *ngIf="accessForm.get('privateKey')?.errors?.['required']">
                                        Private key is required</div>
                                </div>
                                <small class="form-text text-muted">
                                    A demo access key is pre-filled. Just click "Access Claim Information" or press
                                    Enter to continue.
                                </small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeAccessModal()">
                            <i class="fas fa-times me-2"></i>
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg"
                            [disabled]="accessForm.invalid || isLoading" (click)="onSubmit()">
                            <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                            <i *ngIf="!isLoading" class="fas fa-sign-in-alt me-2"></i>
                            {{ isLoading ? 'Authenticating...' : 'Quick Access - Click or Press Enter' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Claims Modal -->
        <div class="modal fade" [class.show]="showClaimsModal" [style.display]="showClaimsModal ? 'block' : 'none'"
            tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-edit me-2"></i>
                            Claims Form
                        </h5>
                        <button type="button" class="btn-close btn-close-white" (click)="closeClaimsModal()"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form [formGroup]="claimsForm" (ngSubmit)="onClaimsFormSubmit()">
                            <div class="row g-3">
                                <!-- Claim Details -->
                                <div class="col-md-6">
                                    <label class="form-label">Claim Number</label>
                                    <input type="text" class="form-control" formControlName="claimNumber"
                                        [readonly]="!isFormEditable">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Policy Number</label>
                                    <input type="text" class="form-control" formControlName="policyNumber"
                                        [readonly]="!isFormEditable">
                                </div>

                                <!-- Incident Details -->
                                <div class="col-md-6">
                                    <label class="form-label">Incident Date</label>
                                    <input type="date" class="form-control" formControlName="incidentDate"
                                        [readonly]="!isFormEditable">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Reported Date</label>
                                    <input type="date" class="form-control" formControlName="reportedDate"
                                        [readonly]="!isFormEditable">
                                </div>

                                <!-- Vehicle Details -->
                                <div class="col-md-4">
                                    <label class="form-label">Make</label>
                                    <input type="text" class="form-control" formControlName="make"
                                        [readonly]="!isFormEditable">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Model</label>
                                    <input type="text" class="form-control" formControlName="model"
                                        [readonly]="!isFormEditable">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Year</label>
                                    <input type="text" class="form-control" formControlName="year"
                                        [readonly]="!isFormEditable">
                                </div>

                                <!-- Damage Details -->
                                <div class="col-12">
                                    <label class="form-label">Damage Description</label>
                                    <textarea class="form-control" rows="3" formControlName="damageDescription"
                                        [readonly]="!isFormEditable"></textarea>
                                </div>

                                <!-- Cost Estimates -->
                                <div class="col-md-6">
                                    <label class="form-label">Estimated Repair Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" formControlName="estimatedCost"
                                            [readonly]="!isFormEditable">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Actual Repair Cost</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" formControlName="actualCost"
                                            [readonly]="!isFormEditable">
                                    </div>
                                </div>

                                <!-- Status -->
                                <div class="col-md-6">
                                    <label class="form-label">Claim Status</label>
                                    <select class="form-select" formControlName="status">
                                        <option value="Pending">Pending</option>
                                        <option value="In Review">In Review</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Denied">Denied</option>
                                        <option value="Closed">Closed</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Priority</label>
                                    <select class="form-select" formControlName="priority">
                                        <option value="Low">Low</option>
                                        <option value="Medium">Medium</option>
                                        <option value="High">High</option>
                                        <option value="Urgent">Urgent</option>
                                    </select>
                                </div>

                                <!-- Notes -->
                                <div class="col-12">
                                    <label class="form-label">Adjuster Notes</label>
                                    <textarea class="form-control" rows="2" formControlName="adjusterNotes"
                                        [readonly]="!isFormEditable"></textarea>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary me-2" (click)="resetClaimsForm()">
                            <i class="fas fa-undo me-2"></i>Reset
                        </button>
                        <button type="button" class="btn btn-secondary me-2" (click)="closeClaimsModal()">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-primary" [disabled]="!isFormEditable"
                            (click)="onClaimsFormSubmit()">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vehicle Modal -->
        <div class="modal fade" [class.show]="showVehicleModal" [style.display]="showVehicleModal ? 'block' : 'none'"
            tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-car me-2"></i>
                            Vehicle Information
                        </h5>
                        <button type="button" class="btn-close btn-close-white" (click)="closeVehicleModal()"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row" *ngIf="vehicle">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Make</label>
                                <input type="text" class="form-control" [(ngModel)]="vehicle.make" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Model</label>
                                <input type="text" class="form-control" [(ngModel)]="vehicle.model" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Year</label>
                                <input type="text" class="form-control" [(ngModel)]="vehicle.year" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">VIN</label>
                                <input type="text" class="form-control" [(ngModel)]="vehicle.vin" readonly>
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Color</label>
                                <input type="text" class="form-control" [(ngModel)]="vehicle.color" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeVehicleModal()">
                            <i class="fas fa-times me-2"></i>
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Editor Modal -->
        <div class="modal fade" [class.show]="showImageEditor" [style.display]="showImageEditor ? 'block' : 'none'"
            id="imageEditorModal" tabindex="-1" aria-labelledby="imageEditorModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="imageEditorModalLabel">
                            <i class="fas fa-edit me-2"></i>
                            Edit Evidence Photo
                        </h5>
                        <button type="button" class="btn-close" (click)="closeImageEditor()"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body" *ngIf="currentEditingImage" #imageEditorModalBody>
                        <div class="row">
                            <!-- Image Canvas Area -->
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">Image Canvas</h6>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-success btn-sm" (click)="manualReloadImage()"
                                                title="Reload Image">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button class="btn btn-outline-primary"
                                                    [class.active]="editorTool === 'select'"
                                                    (click)="setEditorTool('select')" title="Select">
                                                    <i class="fas fa-mouse-pointer"></i>
                                                </button>
                                                <button class="btn btn-outline-primary"
                                                    [class.active]="editorTool === 'draw'"
                                                    (click)="setEditorTool('draw')" title="Draw">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </button>
                                                <button class="btn btn-outline-primary"
                                                    [class.active]="editorTool === 'text'"
                                                    (click)="setEditorTool('text')" title="Add Text">
                                                    <i class="fas fa-font"></i>
                                                </button>
                                                <button class="btn btn-outline-primary"
                                                    [class.active]="editorTool === 'arrow'"
                                                    (click)="setEditorTool('arrow')" title="Arrow">
                                                    <i class="fas fa-long-arrow-alt-right"></i>
                                                </button>
                                                <button class="btn btn-outline-primary"
                                                    [class.active]="editorTool === 'circle'"
                                                    (click)="setEditorTool('circle')" title="Circle">
                                                    <i class="fas fa-circle"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="image-editor-container position-relative">
                                            <!-- Loading indicator -->
                                            <div *ngIf="isImageLoading"
                                                class="position-absolute top-50 start-50 translate-middle">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading image...</span>
                                                </div>
                                                <div class="mt-2 text-center">
                                                    <small class="text-muted">Loading image...</small>
                                                </div>
                                            </div>
                                            <canvas #imageCanvas [width]="canvasWidth" [height]="canvasHeight"
                                                class="border" (mousedown)="onCanvasMouseDown($event)"
                                                (mousemove)="onCanvasMouseMove($event)"
                                                (mouseup)="onCanvasMouseUp($event)"
                                                [style.opacity]="isImageLoading ? '0.3' : '1'"
                                                style="width: 100%; height: auto; cursor: crosshair;">
                                            </canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Editor Controls -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0">Editor Controls</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- Image Info -->
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Image Description</label>
                                            <textarea class="form-control form-control-sm"
                                                [(ngModel)]="currentEditingImage.description" rows="3"></textarea>
                                        </div>

                                        <!-- Color Picker -->
                                        <div class="mb-3" *ngIf="editorTool !== 'select'">
                                            <label class="form-label small fw-bold">Color</label>
                                            <div class="d-flex gap-1 mb-2">
                                                <div class="color-swatch" *ngFor="let color of editorColors"
                                                    [style.background-color]="color"
                                                    [class.active]="selectedColor === color"
                                                    (click)="selectedColor = color"></div>
                                            </div>
                                            <input type="color" class="form-control form-control-color"
                                                [(ngModel)]="selectedColor">
                                        </div>

                                        <!-- Brush Size -->
                                        <div class="mb-3" *ngIf="editorTool === 'draw'">
                                            <label class="form-label small fw-bold">Brush Size: {{ brushSize
                                                }}px</label>
                                            <input type="range" class="form-range" min="1" max="20"
                                                [(ngModel)]="brushSize">
                                        </div>

                                        <!-- Text Input -->
                                        <div class="mb-3" *ngIf="editorTool === 'text'">
                                            <label class="form-label small fw-bold">Text to Add</label>
                                            <input type="text" class="form-control form-control-sm"
                                                [(ngModel)]="textToAdd" placeholder="Enter text...">
                                        </div>

                                        <!-- Actions -->
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-secondary btn-sm" (click)="clearCanvas()">
                                                <i class="fas fa-eraser me-1"></i> Clear Annotations
                                            </button>
                                            <button class="btn btn-outline-info btn-sm" (click)="resetImage()">
                                                <i class="fas fa-undo me-1"></i> Reset Image
                                            </button>
                                            <button class="btn btn-success btn-sm" (click)="updateAnnotations()">
                                                <i class="fas fa-edit me-1"></i> Update Annotations
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" (click)="closeImageEditor()">
                            <i class="fas fa-times me-1"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-success" (click)="updateAnnotations()">
                            <i class="fas fa-edit me-1"></i> Update Annotations
                        </button>
                        <button type="button" class="btn btn-primary" (click)="saveEditedImage()">
                            <i class="fas fa-save me-1"></i> Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Annotation Modal -->
    <div class="modal fade" [class.show]="showAnnotationModal" [style.display]="showAnnotationModal ? 'block' : 'none'"
        id="annotationModal" tabindex="-1" aria-labelledby="annotationModalLabel" [attr.aria-hidden]="!showAnnotationModal"
        (click)="closeAnnotationModal()">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content" (click)="$event.stopPropagation()">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="annotationModalLabel">
                        <i class="fas fa-pen-alt me-2"></i>Add Image with Annotation
                    </h5>
                    <button type="button" class="btn-close btn-close-white" (click)="closeAnnotationModal()"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="annotationFileInput" class="form-label">Select Image</label>
                                <input type="file" class="form-control" id="annotationFileInput"
                                    (change)="onAnnotationFileSelected($event)" accept="image/*">
                                <div class="form-text">Supported formats: JPG, PNG, GIF, BMP</div>
                            </div>
                            
                            <div class="mb-3" *ngIf="selectedImageForAnnotation">
                                <label class="form-label">Preview</label>
                                <div class="border rounded p-2 bg-light">
                                    <img [src]="selectedImageForAnnotation.url" class="img-fluid" alt="Selected image"
                                        style="max-height: 200px;">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="annotationDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="annotationDescription" rows="3"
                                    [(ngModel)]="annotationDescription"
                                    placeholder="Enter description for this image..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h6>Annotation Tools</h6>
                                <div class="btn-group d-block mb-2" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                        [class.active]="annotationTool === 'select'" (click)="annotationTool = 'select'"
                                        title="Select Tool">
                                        <i class="fas fa-mouse-pointer"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                        [class.active]="annotationTool === 'draw'" (click)="annotationTool = 'draw'"
                                        title="Draw Tool">
                                        <i class="fas fa-paint-brush"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                        [class.active]="annotationTool === 'text'" (click)="annotationTool = 'text'"
                                        title="Text Tool">
                                        <i class="fas fa-font"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                        [class.active]="annotationTool === 'circle'" (click)="annotationTool = 'circle'"
                                        title="Circle Tool">
                                        <i class="fas fa-circle"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm"
                                        [class.active]="annotationTool === 'arrow'" (click)="annotationTool = 'arrow'"
                                        title="Arrow Tool">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label">Color</label>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button *ngFor="let color of editorColors" type="button"
                                            class="btn btn-sm rounded-circle color-btn"
                                            [style.background-color]="color"
                                            [class.active]="annotationColor === color"
                                            (click)="annotationColor = color"
                                            [attr.aria-label]="'Select ' + color">
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <label class="form-label">Size: {{ annotationSize }}</label>
                                    <input type="range" class="form-range" min="1" max="10" [(ngModel)]="annotationSize">
                                </div>
                                
                                <div *ngIf="annotationTool === 'text'" class="mb-2">
                                    <label class="form-label">Text</label>
                                    <input type="text" class="form-control form-control-sm" [(ngModel)]="annotationText"
                                        placeholder="Enter text to annotate...">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" *ngIf="selectedImageForAnnotation">
                        <label class="form-label">Annotation Canvas</label>
                        <div class="border rounded bg-light p-2">
                            <canvas #annotationCanvas width="400" height="300" 
                                class="img-fluid border rounded"
                                (mousedown)="onAnnotationCanvasMouseDown($event)"
                                (mousemove)="onAnnotationCanvasMouseMove($event)"
                                (mouseup)="onAnnotationCanvasMouseUp($event)"
                                (mouseleave)="onAnnotationCanvasMouseLeave($event)">
                            </canvas>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" (click)="closeAnnotationModal()">
                        <i class="fas fa-times me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-success" (click)="saveAnnotation()"
                        [disabled]="!selectedImageForAnnotation">
                        <i class="fas fa-save me-1"></i> Save Image
                    </button>
                </div>
            </div>
        </div>
    </div>